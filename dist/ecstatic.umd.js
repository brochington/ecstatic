!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("ecstatic",[],e):"object"==typeof exports?exports.ecstatic=e():t.ecstatic=e()}(self,()=>(()=>{"use strict";var t,e={};e.d=(t,s)=>{for(var o in s)e.o(s,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:s[o]})},e.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),e.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};e.r(s),e.d(s,{Entity:()=>y,World:()=>w,trackComponent:()=>g});var o=new Uint8Array(16);let n=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;for(var i=[],r=0;r<256;++r)i.push((r+256).toString(16).substr(1));let l=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=(i[t[e+0]]+i[t[e+1]]+i[t[e+2]]+i[t[e+3]]+"-"+i[t[e+4]]+i[t[e+5]]+"-"+i[t[e+6]]+i[t[e+7]]+"-"+i[t[e+8]]+i[t[e+9]]+"-"+i[t[e+10]]+i[t[e+11]]+i[t[e+12]]+i[t[e+13]]+i[t[e+14]]+i[t[e+15]]).toLowerCase();if(!("string"==typeof s&&n.test(s)))throw TypeError("Stringified UUID is invalid");return s},a=function(e,s,n){var i=(e=e||{}).random||(e.rng||function(){if(!t&&!(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(o)})();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,s){n=n||0;for(var r=0;r<16;++r)s[n+r]=i[r];return s}return l(i)};function d(t,e){return!!e&&e instanceof t}class h{components=new Map;add=t=>{this.components.set(t.constructor.name,t)};update=(t,e)=>{let s=this.components.get(t.name);if(d(t,s)){let o=e(s);this.components.set(t.name,o)}};remove=t=>{this.components.delete(t.name)};get=t=>{let e=this.components.get(t.name);if(d(t,e))return e;throw Error(`ComponentCollection does not have component of type ${t.name}`)};has=t=>Array.isArray(t)?t.every(t=>!0===this.components.has(t.name)):this.components.has(t.name);hasByName=t=>Array.isArray(t)?t.every(t=>!0===this.components.has(t)):this.components.has(t);get componentTypes(){return[...this.components.keys()]}get size(){return this.components.size}[Symbol.iterator](){return this.components.values()}toDevComponents(){let t={};for(let[e,s]of this.components)t[e]=s;return t}}let m=class{id;components;tags;systems=[];state;constructor(t,e){this.id=t.id,this.components=t.components.toDevComponents(),this.tags=[...t.tags],this.state=t.state;const s=Object.keys(this.components);for(const[t,o]of e.systems.compNamesBySystemName)o.every(t=>s.includes(t))&&this.systems.push(t)}toTableRow(){return{id:this.id,components:Object.keys(this.components).join(", "),tags:this.tags.join(", "),systems:this.systems.join(", ")}}};class c{current;inital;transitions;constructor(t,e){this.inital=t,this.current=t,this.transitions=e}next(t){this.transitions[this.current]&&(this.current=this.transitions[this.current](t,this.current))}reset(){this.current=this.inital}is(t){return this.current===t}}class y{_id;_world;_error;_state;get id(){return this._id}get world(){return this._world}get state(){return this._state.current}constructor(t){this._id=a(),this._world=t,this._error=null;const e=t=>"error"===t||this._error?"error":t;this._state=new c("creating",{creating:e,created:e,destroying:e,destroyed:()=>"destroyed",error:()=>"error"}),this._world.registerEntity(this),0===this._world.systems.compNamesBySystemName.size&&this._state.next("created")}onCreate(t){}onDestroy(t){}onComponentAdd(t){}onTrackedComponentUpdate(t){}onComponentRemove(t){}add(t){return this._world.add(this._id,t),this}addTag(t){let e=this._world.entitiesByTags.has(t)?this._world.entitiesByTags.get(t):new Set;return e&&(e.add(this._id),this._world.entitiesByTags.set(t,e)),this}has(t){return(this._world.componentCollections.get(this._id)||new h).has(t)}hasTag(t){if(this._world.entitiesByTags.has(t)){let e=this._world.entitiesByTags.get(t);if(e)return e.has(this._id)}return!1}get(t){return(this._world.componentCollections.get(this._id)||new h).get(t)}getAll(){return this._world.componentCollections.get(this._id)||new h}remove(t){return this._world.remove(this._id,t),this}removeTag(t){if(this._world.entitiesByTags.has(t)){let e=this._world.entitiesByTags.get(t);e&&(e.delete(this._id),0===e.size&&this._world.entitiesByTags.delete(t))}return this}clear(){return this._world.clearEntityComponents(this._id),this}clearTags(){for(let[t,e]of this._world.entitiesByTags.entries())e.delete(this._id),0===e.size&&this._world.entitiesByTags.delete(t);return this}finishCreation(){this._state.next("created")}destroy(){0===this._world.systems.compNamesBySystemName.size?this.destroyImmediately():this._state.next("destroying")}destroyImmediately(){this.onDestroy(this._world),this._world.destroyEntity(this._id),this._state.next("destroyed")}get components(){return this._world.componentCollections.get(this._id)||new h}get tags(){let t=new Set;for(let[e,s]of this._world.entitiesByTags.entries())s.has(this._id)&&t.add(e);return t}toDevEntity(){return new m(this,this._world)}}let p=class{world;constructor(t){this.world=t}get systemComponents(){let t=[];for(let[e,s]of this.world.systems.compNamesBySystemName)t.push({system:e,components:s.join(", ")});return t}get entities(){return[...this.world.entities.values()].map(t=>t.toDevEntity())}};class u{world;systemFuncBySystemName;compNamesBySystemName;constructor(t){this.world=t,this.systemFuncBySystemName=new Map,this.compNamesBySystemName=new Map}add(t,e,s,o){let n=t.map(t=>t.name),i=o||e.name;return""!==i&&i||(i=s),this.systemFuncBySystemName.set(i,{func:e,key:s}),this.compNamesBySystemName.set(i,n),this.world.entitiesByCTypes.has(s)||this.world.entitiesByCTypes.set(s,new Set),this}run(){let t=[],e=[];for(let s of this.world.entities.values())"creating"===s.state?t.push(s):"destroying"===s.state&&e.push(s);for(let{func:t,key:e}of this.systemFuncBySystemName.values()){let s=this.world.entitiesByCTypes.get(e)||new Set,o=s.size;if(0===o)continue;let n=0;for(let e of s){let s=this.world.entities.get(e);s&&(t({entity:s,components:this.world.componentCollections.get(e)||new h,world:this.world,index:n,size:o,isFirst:0===n,isLast:n+1===o}),n++)}}for(let e of t)e.finishCreation();for(let t of e)t.destroyImmediately()}}let f={isTracked:Symbol.for("ecs.trackedComponent.isTracked"),world:Symbol.for("ecs.trackedComponent.world"),entityIDs:Symbol.for("ecs.trackedComponent.entityIDs"),getEntities:Symbol.for("ecs.trackedComponent.getEntities"),setWorld:Symbol.for("ecs.trackedComponent.setWorld"),onAdd:Symbol.for("ecs.trackedComponent.onAdd"),onUpdate:Symbol.for("ecs.trackedComponent.onUpdate"),onRemove:Symbol.for("ecs.trackedComponent.onRemove")};function g(t,e){return new Proxy(t,{construct(t,s){let o,n=new t(...s);return n[f.isTracked]=!0,n[f.setWorld]=t=>{n[f.world]=t},n[f.entityIDs]=new Set,n[f.getEntities]=t=>{let e=new Map;for(let s of n[f.entityIDs]){let o=t.entities.get(s);o&&e.set(s,o)}return e},n[f.onAdd]=(t,s)=>{if(e.onAdd){let o=n[f.getEntities](t);e.onAdd({component:n,world:t,entity:s,entities:o})}},n[f.onRemove]=(t,s)=>{if(e.onRemove){let o=n[f.getEntities](t);e.onRemove({component:n,world:t,entity:s,entities:o})}},new Proxy(n,(o=new Set,{set(t,s,n){o.add(s);let i=t[f.world],r=t[s];t[s]=n;let l=t[f.getEntities](i);for(let e of l.values())e.onTrackedComponentUpdate({world:i,component:t});return e.onUpdate&&e.onUpdate({entities:l,world:i,component:t,previousVal:r,property:s}),!0}}))}})}class w{componentCollections=new Map;entities=new Map;entitiesByCTypes=new Map;entitiesByTags=new Map;systems;dev;componentToSystemQueries=new Map;constructor(){this.dev=new p(this),this.systems=new u(this)}find=t=>{for(let e of this.entities.values())if(t(e))return e;return null};findAll=t=>{let e=[];for(let s of this.entities.values())t(s)&&e.push(s);return e};locate=t=>{for(let e of this.entities.values())if(e.components.has(t))return e;return null};locateAll=t=>{let e=[];for(let s of this.entities.values())s.components.has(t)&&e.push(s);return e};grab=t=>{let e=this.locate(t);if(e){let s=(this.componentCollections.get(e.id)||new h).get(t);return{entity:e,component:s}}return null};grabBy=(t,e)=>{for(let s of this.locateAll(t)){let o=(this.componentCollections.get(s.id)||new h).get(t);if(e(o))return{component:o,entity:s}}return null};grabAll=t=>this.locateAll(t).map(e=>({entity:e,component:e.components.get(t)}));get=(t,e)=>(this.componentCollections.get(t)||new h).get(e);getComponent=(t,e)=>{let s=this.grab(t);return s?s.component:e||null};getTagged=t=>{let e=this.entitiesByTags.get(t);if(e){let t=e.values().next().value;if(t){let e=this.entities.get(t);if(e)return e}}return null};getAllTagged=t=>{let e=[],s=this.entitiesByTags.get(t);if(s)for(let t of s){let s=this.entities.get(t);s&&e.push(s)}return e};add=(t,e)=>{let s=this.componentCollections.get(t)||new h,o=this.entities.get(t);if(!o)throw Error(`world.add: Unable to locate entity with id ${t}`);for(let[o,n]of(s.add(e),this.componentCollections.set(t,s),this.entitiesByCTypes))o.split(",").every(s.hasByName)&&n.add(t);return e[f.isTracked]&&(e[f.setWorld](this),e[f.entityIDs].add(t),e[f.onAdd](this,o)),o.onComponentAdd({world:this,component:e}),this};remove=(t,e)=>{let s=this.componentCollections.get(t);if(!s)return this;let o=e.name;if(!s.hasByName(o))return this;let n=s.get(e);if(n[f.isTracked]){let s=this.entities.get(t);if(!s)throw Error(`world.remove: Unable to locate entity for TrackedComponent. eid: ${t}, cType: ${e.name}`);n[f.entityIDs].delete(t),n[f.onRemove](this,s)}for(let e of this.componentToSystemQueries.get(o)||[]){let s=this.entitiesByCTypes.get(e);s&&s.delete(t)}for(let[o,n]of(s.remove(e),this.entitiesByCTypes.entries()))o.split(",").every(t=>s.hasByName(t))&&n.add(t);let i=this.entities.get(t);return i&&i.onComponentRemove({world:this,component:n}),this};addSystem(t,e,s){let o=t.map(t=>t.name).sort(),n=o.join(",");for(let t of o){let e=this.componentToSystemQueries.get(t)||[];e.includes(n)||e.push(n),this.componentToSystemQueries.set(t,e)}return this.systems.add(t,e,n,s),this}registerEntity(t){let e=new h;return this.componentCollections.set(t.id,e),this.entities.set(t.id,t),t.onCreate(this),this}clearEntityComponents(t){for(let e of(this.componentCollections.set(t,new h),this.entitiesByCTypes.values()))e.has(t)&&e.delete(t);return this}createEntity(){return new y(this)}destroyEntity(t){if(this.componentCollections.delete(t),!this.entities.get(t))throw Error(`world.destroyEntity: No entity found. entity id: ${t}`);for(let e of(this.entities.delete(t),this.entitiesByCTypes.values()))e.has(t)&&e.delete(t);for(let[e,s]of this.entitiesByTags)s.has(t)&&s.delete(t),0===s.size&&this.entitiesByTags.delete(e);return this}}return s})());