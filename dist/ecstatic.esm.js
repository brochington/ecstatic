function k(c,t){return!(!t||!(t instanceof c))}var m=class{components=new Map;add=t=>{this.components.set(t.constructor.name,t)};update=(t,e)=>{let s=this.components.get(t.name);if(k(t,s)){let n=e(s);this.components.set(t.name,n)}};remove=t=>{this.components.delete(t.name)};get=t=>{let e=this.components.get(t.name);if(k(t,e))return e;throw new Error(`ComponentCollection does not have component of type ${t.name}`)};has=t=>Array.isArray(t)?t.every(e=>this.components.has(e.name)===!0):this.components.has(t.name);hasSome=t=>t.some(e=>this.components.has(e.name)===!0);hasByName=t=>Array.isArray(t)?t.every(e=>this.components.has(e)===!0):this.components.has(t);get componentTypes(){return[...this.components.keys()]}get size(){return this.components.size}[Symbol.iterator](){return this.components.values()}toDevComponents(){let t={};for(let[e,s]of this.components)t[e]=s;return t}};var b=class{id;components;tags;systems=[];state;constructor(t,e){this.id=t.id,this.components=t.components.toDevComponents(),this.tags=[...t.tags],this.state=t.state;let s=Object.keys(this.components);for(let[n,o]of e.systems.compNamesBySystemName)o.every(r=>s.includes(r))&&this.systems.push(n)}toTableRow(){return{id:this.id,components:Object.keys(this.components).join(", "),tags:this.tags.join(", "),systems:this.systems.join(", ")}}},A=b;var T=class{current;inital;transitions;constructor(t,e){this.inital=t,this.current=t,this.transitions=e}next(t){this.transitions[this.current]&&(this.current=this.transitions[this.current](t,this.current))}reset(){this.current=this.inital}is(t){return this.current===t}};var d=class c{mask;size;constructor(t=1){this.size=t,this.mask=new Uint32Array(t)}set(t){let e=Math.floor(t/32),s=t%32;e>=this.mask.length&&this.resize(e+1),this.mask[e]|=1<<s}clear(t){let e=Math.floor(t/32),s=t%32;e<this.mask.length&&(this.mask[e]&=~(1<<s))}resize(t){let e=new Uint32Array(t);e.set(this.mask),this.mask=e,this.size=t}contains(t){let e=t.mask.length;for(let s=0;s<e;s++){let n=t.mask[s];if((this.mask[s]&n)!==n)return!1}return!0}intersects(t){let e=Math.min(this.mask.length,t.mask.length);for(let s=0;s<e;s++)if((this.mask[s]&t.mask[s])!==0)return!0;return!1}equals(t){let e=Math.max(this.mask.length,t.mask.length);for(let s=0;s<e;s++){let n=this.mask[s]||0,o=t.mask[s]||0;if(n!==o)return!1}return!0}count(){let t=0,e=this.mask.length;for(let s=0;s<e;s++){let n=this.mask[s];n=n-(n>>>1&1431655765),n=(n&858993459)+(n>>>2&858993459),t+=(n+(n>>>4)&252645135)*16843009>>>24}return t}toString(){return this.mask.join("-")}clone(){let t=new c(this.size);return t.mask.set(this.mask),t}};var C=class{_id;_world;_componentMask;_error;_state;get id(){return this._id}get world(){return this._world}get componentMask(){return this._componentMask}get state(){return this._state.current}constructor(t,e){this._id=e,this._world=t,this._componentMask=new d,this._error=null;let s=n=>n==="error"||this._error?"error":n;this._state=new T("creating",{creating:s,created:s,destroying:s,destroyed:()=>"destroyed",error:()=>"error"}),this._world.registerEntity(this),this._world.systems.compNamesBySystemName.size===0&&this._state.next("created")}onCreate(t){}onDestroy(t){}onComponentAdd(t){}onTrackedComponentUpdate(t){}onComponentRemove(t){}add(t){if(!t)throw new Error("Entity.add: Component is null or undefined");return this._world.add(this._id,t),this}addTag(t){let e=this._world.entitiesByTags.has(t)?this._world.entitiesByTags.get(t):new Set;return e&&(e.add(this._id),this._world.entitiesByTags.set(t,e)),this}has(t){return(this._world.componentCollections[this._id]||new m).has(t)}hasSome(t){return(this._world.componentCollections[this._id]||new m).hasSome(t)}hasTag(t){if(this._world.entitiesByTags.has(t)){let e=this._world.entitiesByTags.get(t);if(e)return e.has(this._id)}return!1}get(t){return(this._world.componentCollections[this._id]||new m).get(t)}getAll(){return this._world.componentCollections[this._id]||new m}remove(t){return this._world.remove(this._id,t),this}removeTag(t){if(this._world.entitiesByTags.has(t)){let e=this._world.entitiesByTags.get(t);e&&(e.delete(this._id),e.size===0&&this._world.entitiesByTags.delete(t))}return this}clear(){return this._world.clearEntityComponents(this._id),this._componentMask=new d,this}clearTags(){for(let[t,e]of this._world.entitiesByTags.entries())e.delete(this._id),e.size===0&&this._world.entitiesByTags.delete(t);return this}finishCreation(){this._state.next("created")}destroy(){if(this._world.systems.compNamesBySystemName.size===0){this.destroyImmediately();return}this._state.next("destroying"),this._world.entitiesToDestroy.add(this)}destroyImmediately(){this.onDestroy(this._world),this._world.destroyEntity(this._id),this._state.next("destroyed")}get components(){return this._world.componentCollections[this._id]||new m}get tags(){let t=new Set;for(let[e,s]of this._world.entitiesByTags.entries())s.has(this._id)&&t.add(e);return t}toDevEntity(){return new A(this,this._world)}};var x=class{world;constructor(t){this.world=t}get systemComponents(){let t=[];for(let[e,s]of this.world.systems.compNamesBySystemName)t.push({system:e,components:s.join(", ")});return t}get entities(){return this.world.entities.filter(t=>t!==void 0).map(t=>t.toDevEntity())}},W=x;var y="__DEFAULT__",g=class{world;compNamesBySystemName;phases=new Map;phaseOrder=["Input","Logic","Events","Render","Cleanup"];constructor(t){this.world=t,this.compNamesBySystemName=new Map,this.phases.set(y,[])}setPhaseOrder(t){this.phaseOrder=t}add(t,e,s={}){let{phase:n=y,name:o}=s,r=o||e.name||t.key;this.phases.has(n)||this.phases.set(n,[]),this.phases.get(n)?.push({func:e,name:r,query:t});let i=Array.from(t.relevantComponents);return this.compNamesBySystemName.set(r,i),this.validatePhases(),this}validatePhases(){let e=(this.phases.get(y)||[]).length>0,s=Array.from(this.phases.keys()).some(n=>n!==y&&(this.phases.get(n)?.length??0)>0);if(e&&s)throw new Error("Ambiguous system execution order: Some systems are registered with a phase, while others are not. Please assign a phase to all systems if you intend to use execution phases.")}run(t){let e=t?.dt??16.666,s=t?.time??performance.now(),n={entity:null,components:null,world:this.world,index:0,size:0,isFirst:!1,isLast:!1,dt:e,time:s},o=[],r=this.phases.get(y);if(r&&r.length>0)o.push(y);else{for(let i of this.phaseOrder)o.push(i);for(let i of this.phases.keys())i!==y&&!this.phaseOrder.includes(i)&&o.push(i)}for(let i of o){let l=this.phases.get(i);if(l&&l.length>0)for(let h of l){let M=h.query.entities,S=M.size;if(S===0)continue;let w=0;n.size=S;for(let I of M){let f=this.world.entities[I];if(!f||f.state!=="created"&&f.state!=="creating"&&f.state!=="destroying")continue;let _=this.world.componentCollections[I];_&&(n.entity=f,n.components=_,n.index=w,n.isFirst=w===0,n.isLast=w+1===S,h.func(n),w++)}}this.world.events.processQueueForPhase(i)}if(this.world.entitiesToCreate.size>0){for(let i of this.world.entitiesToCreate)i.finishCreation();this.world.entitiesToCreate.clear()}if(this.world.entitiesToDestroy.size>0){for(let i of this.world.entitiesToDestroy)i.destroyImmediately();this.world.entitiesToDestroy.clear()}this.world.events.clearQueue()}};var a={isTracked:Symbol.for("ecs.trackedComponent.isTracked"),world:Symbol.for("ecs.trackedComponent.world"),entityIDs:Symbol.for("ecs.trackedComponent.entityIDs"),getEntities:Symbol.for("ecs.trackedComponent.getEntities"),setWorld:Symbol.for("ecs.trackedComponent.setWorld"),onAdd:Symbol.for("ecs.trackedComponent.onAdd"),onUpdate:Symbol.for("ecs.trackedComponent.onUpdate"),onRemove:Symbol.for("ecs.trackedComponent.onRemove")};function N(c){let t=new Set;return{set(e,s,n){t.add(s);let o=e[a.world],r=e[s];e[s]=n;let i=e[a.getEntities](o);for(let l of i.values())l.onTrackedComponentUpdate({world:o,component:e});return c.onUpdate&&c.onUpdate({entities:i,world:o,component:e,previousVal:r,property:s}),!0}}}function D(c,t){return new Proxy(c,{construct(e,s){let n=new e(...s);return n[a.isTracked]=!0,n[a.setWorld]=o=>{n[a.world]=o},n[a.entityIDs]=new Set,n[a.getEntities]=o=>{let r=new Map;for(let i of n[a.entityIDs]){let l=o.entities[i];l&&r.set(i,l)}return r},n[a.onAdd]=(o,r)=>{if(t.onAdd){let i=n[a.getEntities](o);t.onAdd({component:n,world:o,entity:r,entities:i})}},n[a.onRemove]=(o,r)=>{if(t.onRemove){let i=n[a.getEntities](o);t.onRemove({component:n,world:o,entity:r,entities:i})}},new Proxy(n,N(t))}})}var E=class{world;listeners=new Map;queue=[];constructor(t){this.world=t}addListener(t,e,s){this.listeners.has(t)||this.listeners.set(t,[]);let n=this.listeners.get(t);n&&n.push({func:e,phase:s})}emit(t){this.queue.push(t)}processQueueForPhase(t){let e=[...this.queue];for(let s of e){let n=s.constructor,o=this.listeners.get(n)||[];for(let r of o)r.phase===t&&r.func({event:s,world:this.world})}}clearQueue(){this.queue=[]}};var u=class{static nextId=0;static registry=new Map;static getId(t){return this.registry.has(t)||this.registry.set(t,this.nextId++),this.registry.get(t)}};var p=class{world;entities=new Set;key;allMask=null;anyMask=null;noneMask=null;onlyMask=null;differentMask=null;minCount=0;maxCount=1/0;isUniversal;relevantComponents=new Set;constructor(t,e){this.world=t;let s=[];if(e.all&&e.all.length>0){let o=[...e.all].sort((r,i)=>r.name.localeCompare(i.name));this.allMask=new d,o.forEach(r=>{this.allMask?.set(u.getId(r)),this.relevantComponents.add(r.name)}),s.push(`all:${o.map(r=>r.name).join(",")}`)}if(e.any&&e.any.length>0){let o=[...e.any].sort((r,i)=>r.name.localeCompare(i.name));this.anyMask=new d,o.forEach(r=>{this.anyMask?.set(u.getId(r)),this.relevantComponents.add(r.name)}),s.push(`any:${o.map(r=>r.name).join(",")}`)}if(e.none&&e.none.length>0){let o=[...e.none].sort((r,i)=>r.name.localeCompare(i.name));this.noneMask=new d,o.forEach(r=>{this.noneMask?.set(u.getId(r)),this.relevantComponents.add(r.name)}),s.push(`none:${o.map(r=>r.name).join(",")}`)}let n=e.only||e.same;if(n&&n.length>0){let o=[...n].sort((r,i)=>r.name.localeCompare(i.name));this.onlyMask=new d,o.forEach(r=>this.onlyMask?.set(u.getId(r))),s.push(`only:${o.map(r=>r.name).join(",")}`)}if(e.different&&e.different.length>0){let o=[...e.different].sort((r,i)=>r.name.localeCompare(i.name));this.differentMask=new d,o.forEach(r=>this.differentMask?.set(u.getId(r))),s.push(`diff:${o.map(r=>r.name).join(",")}`)}e.min!==void 0&&(this.minCount=e.min,s.push(`min:${e.min}`)),e.max!==void 0&&(this.maxCount=e.max,s.push(`max:${e.max}`)),this.key=s.join("|"),this.isUniversal=!!this.onlyMask||!!this.differentMask||this.minCount>0||this.maxCount<1/0}match(t){let e=t.componentMask;if(this.allMask&&!e.contains(this.allMask)||this.noneMask&&e.intersects(this.noneMask)||this.anyMask&&!e.intersects(this.anyMask)||this.onlyMask&&!e.equals(this.onlyMask)||this.differentMask&&e.equals(this.differentMask))return!1;if(this.minCount>0||this.maxCount<1/0){let s=e.count();if(s<this.minCount||s>this.maxCount)return!1}return!0}*[Symbol.iterator](){for(let t of this.entities){let e=this.world.entities[t];e&&(yield e)}}get(){return Array.from(this)}first(){let e=this.entities.values().next().value;return e!==void 0&&this.world.entities[e]||null}get size(){return this.entities.size}};var v=class c{componentCollections=[];entities=[];queries=new Map;entitiesByTags=new Map;entitiesToCreate=new Set;entitiesToDestroy=new Set;systems;dev;events;nextEntityId=0;componentToQueries=new Map;universalQueries=new Set;resources=new Map;prefabs=new Map;constructor(){this.dev=new W(this),this.systems=new g(this),this.events=new E(this)}query(t){let e=new p(this,t),s=e.key;if(this.queries.has(s))return this.queries.get(s);this.queries.set(s,e);for(let n of this.entities)n&&n.state!=="destroyed"&&e.match(n)&&e.entities.add(n.id);if(e.isUniversal)this.universalQueries.add(s);else for(let n of e.relevantComponents)this.componentToQueries.has(n)||this.componentToQueries.set(n,new Set),this.componentToQueries.get(n)?.add(s);return e}addSystemListener(t,e,s={}){let{phase:n="Events"}=s;return this.events.addListener(t,e,n),this}setResource(t){return this.resources.set(t.constructor,t),this}getResource(t){return this.resources.get(t)}hasResource(t){return this.resources.has(t)}removeResource(t){return this.resources.delete(t)}registerPrefab(t,e){return this.prefabs.set(t,e),this}createEntityFromPrefab(t,e={}){let s=this.prefabs.get(t);if(!s)throw new Error(`Prefab with name "${t}" not found.`);let n=this.createEntity();if(s.tags)for(let o of s.tags)n.addTag(o);for(let o of s.components){let r=JSON.parse(JSON.stringify(o)),i=o;Object.setPrototypeOf(r,i.constructor.prototype);let l=i.constructor.name;e[l]&&Object.assign(r,e[l]),n.add(r)}return n}setPhaseOrder(t){return this.systems.setPhaseOrder(t),this}find=t=>{for(let e of this.entities)if(e&&t(e))return e;return null};findAll=t=>{let e=[];for(let s of this.entities)s&&t(s)&&e.push(s);return e};locate=t=>{let n=`all:${(Array.isArray(t)?t:[t]).map(o=>o.name).sort().join(",")}`;if(this.queries.has(n))return this.queries.get(n).first();for(let o of this.entities)if(o&&o.components.has(t))return o;return null};locateAll=t=>{let n=`all:${(Array.isArray(t)?t:[t]).map(r=>r.name).sort().join(",")}`;if(this.queries.has(n))return this.queries.get(n)?.get()||[];let o=[];for(let r of this.entities)r&&r.components.has(t)&&o.push(r);return o};grab=t=>{let e=this.locate(t);if(e){let n=(this.componentCollections[e.id]||new m).get(t);return{entity:e,component:n}}return null};grabBy=(t,e)=>{let s=this.locateAll(t);for(let n of s){let r=(this.componentCollections[n.id]||new m).get(t);if(e(r))return{component:r,entity:n}}return null};grabAll=t=>this.locateAll(t).map(s=>({entity:s,component:s.components.get(t)}));get=(t,e)=>(this.componentCollections[t]||new m).get(e);getComponent=(t,e)=>{let s=this.grab(t);return s?s.component:e||null};getTagged=t=>{let e=this.entitiesByTags.get(t);if(e){let s=e.values().next().value;if(s!==void 0){let n=this.entities[s];if(n)return n}}return null};getAllTagged=t=>{let e=[],s=this.entitiesByTags.get(t);if(s)for(let n of s){let o=this.entities[n];o&&e.push(o)}return e};add=(t,e)=>{let s=this.componentCollections[t];s||(s=new m,this.componentCollections[t]=s);let n=this.entities[t];if(!n)throw new Error(`world.add: Unable to locate entity with id ${t}`);let o=u.getId(e.constructor);n.componentMask.set(o),s.add(e),this.updateQueries(n,e.constructor.name),e[a.isTracked]&&(e[a.setWorld](this),e[a.entityIDs].add(t),e[a.onAdd](this,n));let r=e;return r.onAdd&&r.onAdd({world:this,entity:n,component:e}),n.onComponentAdd({world:this,component:e}),this};remove=(t,e)=>{let s=this.componentCollections[t];if(!s)return this;let n=e.name;if(!s.hasByName(n))return this;let o=s.get(e),r=this.entities[t];if(!r)return this;let i=o;i.onRemove&&i.onRemove({world:this,entity:r,component:o}),o[a.isTracked]&&(o[a.entityIDs].delete(t),o[a.onRemove](this,r));let l=u.getId(e);return r.componentMask.clear(l),s.remove(e),this.updateQueries(r,n),r.onComponentRemove({world:this,component:o}),this};updateQueries(t,e){let s=this.componentToQueries.get(e);if(s)for(let n of s)this.checkQuery(n,t);for(let n of this.universalQueries)this.checkQuery(n,t)}checkQuery(t,e){let s=this.queries.get(t);if(!s)return;let n=s.match(e),o=s.entities.has(e.id);n&&!o?s.entities.add(e.id):!n&&o&&s.entities.delete(e.id)}addSystem(t,e,s={}){let n;return t instanceof p?(n=t,this.queries.has(n.key)||this.queries.set(n.key,n)):Array.isArray(t)?n=this.query({all:t}):n=this.query(t),this.systems.add(n,e,s),this}registerEntity(t){let e=new m;return this.componentCollections[t.id]=e,this.entities[t.id]=t,this.entitiesToCreate.add(t),t.onCreate(this),this}clearEntityComponents(t){this.componentCollections[t]=new m;for(let e of this.queries.values())e.entities.has(t)&&e.entities.delete(t);return this}createEntity(){let t=++this.nextEntityId;return new C(this,t)}destroyEntity(t){delete this.componentCollections[t];let e=this.entities[t];if(!e)throw new Error(`world.destroyEntity: No entity found. entity id: ${t}`);delete this.entities[t],this.entitiesToCreate.delete(e),this.entitiesToDestroy.delete(e);for(let s of this.queries.values())s.entities.has(t)&&s.entities.delete(t);for(let[s,n]of this.entitiesByTags)n.has(t)&&n.delete(t),n.size===0&&this.entitiesByTags.delete(s);return this}toJSON(){let t={resources:[],entities:[]};for(let[e,s]of this.resources.entries()){let n=s,o=n.toJSON?n.toJSON():{...s};t.resources.push({name:e.name,data:o})}for(let e of this.entities){if(!e)continue;let s=[],n=this.componentCollections[e.id];if(n)for(let o of n){let r=o,i=r.toJSON?r.toJSON():{...o};s.push({name:o.constructor.name,data:i})}t.entities.push({id:e.id,tags:Array.from(e.tags),components:s})}return t}static fromJSON(t,e){let s=new c;for(let o of t.resources){let r=e.resources[o.name];if(!r)throw new Error(`Cannot hydrate resource: Class constructor for "${o.name}" not found in typeMapping.resources.`);let i;r.fromJSON?i=r.fromJSON(o.data):(i=new r,Object.assign(i,o.data)),s.setResource(i)}let n=0;for(let o of t.entities)typeof o.id=="number"&&o.id>n&&(n=o.id);s.nextEntityId=n;for(let o of t.entities){let r=new C(s,o.id);s.registerEntity(r);for(let i of o.tags)r.addTag(i);for(let i of o.components){let l=e.components[i.name];if(!l)throw new Error(`Cannot hydrate component: Class constructor for "${i.name}" not found in typeMapping.components.`);let h;l.fromJSON?h=l.fromJSON(i.data):(h=new l,Object.assign(h,i.data)),r.add(h)}}return s}};export{d as BitSet,u as ComponentRegistry,C as Entity,p as Query,v as World,D as trackComponent};
//# sourceMappingURL=ecstatic.esm.js.map
