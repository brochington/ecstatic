(()=>{"use strict";let t;var e,o,s={};s.d=(t,e)=>{for(var o in e)s.o(e,o)&&!s.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},s.g=(()=>{if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(t){if("object"==typeof window)return window}})(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};s.r(n),s.d(n,{Entity:()=>T,World:()=>b,trackComponent:()=>O}),(e=o||(o={}))[e.PLAIN_TO_CLASS=0]="PLAIN_TO_CLASS",e[e.CLASS_TO_PLAIN=1]="CLASS_TO_PLAIN",e[e.CLASS_TO_CLASS=2]="CLASS_TO_CLASS";var r=new(function(){function t(){this._typeMetadatas=new Map,this._transformMetadatas=new Map,this._exposeMetadatas=new Map,this._excludeMetadatas=new Map,this._ancestorsMap=new Map}return t.prototype.addTypeMetadata=function(t){this._typeMetadatas.has(t.target)||this._typeMetadatas.set(t.target,new Map),this._typeMetadatas.get(t.target).set(t.propertyName,t)},t.prototype.addTransformMetadata=function(t){this._transformMetadatas.has(t.target)||this._transformMetadatas.set(t.target,new Map),this._transformMetadatas.get(t.target).has(t.propertyName)||this._transformMetadatas.get(t.target).set(t.propertyName,[]),this._transformMetadatas.get(t.target).get(t.propertyName).push(t)},t.prototype.addExposeMetadata=function(t){this._exposeMetadatas.has(t.target)||this._exposeMetadatas.set(t.target,new Map),this._exposeMetadatas.get(t.target).set(t.propertyName,t)},t.prototype.addExcludeMetadata=function(t){this._excludeMetadatas.has(t.target)||this._excludeMetadatas.set(t.target,new Map),this._excludeMetadatas.get(t.target).set(t.propertyName,t)},t.prototype.findTransformMetadatas=function(t,e,s){return this.findMetadatas(this._transformMetadatas,t,e).filter(function(t){return!t.options||!0===t.options.toClassOnly&&!0===t.options.toPlainOnly||(!0===t.options.toClassOnly?s===o.CLASS_TO_CLASS||s===o.PLAIN_TO_CLASS:!0!==t.options.toPlainOnly||s===o.CLASS_TO_PLAIN)})},t.prototype.findExcludeMetadata=function(t,e){return this.findMetadata(this._excludeMetadatas,t,e)},t.prototype.findExposeMetadata=function(t,e){return this.findMetadata(this._exposeMetadatas,t,e)},t.prototype.findExposeMetadataByCustomName=function(t,e){return this.getExposedMetadatas(t).find(function(t){return t.options&&t.options.name===e})},t.prototype.findTypeMetadata=function(t,e){return this.findMetadata(this._typeMetadatas,t,e)},t.prototype.getStrategy=function(t){var e=this._excludeMetadatas.get(t),o=e&&e.get(void 0),s=this._exposeMetadatas.get(t),n=s&&s.get(void 0);return o&&n||!o&&!n?"none":o?"excludeAll":"exposeAll"},t.prototype.getExposedMetadatas=function(t){return this.getMetadata(this._exposeMetadatas,t)},t.prototype.getExcludedMetadatas=function(t){return this.getMetadata(this._excludeMetadatas,t)},t.prototype.getExposedProperties=function(t,e){return this.getExposedMetadatas(t).filter(function(t){return!t.options||!0===t.options.toClassOnly&&!0===t.options.toPlainOnly||(!0===t.options.toClassOnly?e===o.CLASS_TO_CLASS||e===o.PLAIN_TO_CLASS:!0!==t.options.toPlainOnly||e===o.CLASS_TO_PLAIN)}).map(function(t){return t.propertyName})},t.prototype.getExcludedProperties=function(t,e){return this.getExcludedMetadatas(t).filter(function(t){return!t.options||!0===t.options.toClassOnly&&!0===t.options.toPlainOnly||(!0===t.options.toClassOnly?e===o.CLASS_TO_CLASS||e===o.PLAIN_TO_CLASS:!0!==t.options.toPlainOnly||e===o.CLASS_TO_PLAIN)}).map(function(t){return t.propertyName})},t.prototype.clear=function(){this._typeMetadatas.clear(),this._exposeMetadatas.clear(),this._excludeMetadatas.clear(),this._ancestorsMap.clear()},t.prototype.getMetadata=function(t,e){var o,s=t.get(e);s&&(o=Array.from(s.values()).filter(function(t){return void 0!==t.propertyName}));for(var n=[],r=0,i=this.getAncestors(e);r<i.length;r++){var a=i[r],p=t.get(a);if(p){var l=Array.from(p.values()).filter(function(t){return void 0!==t.propertyName});n.push.apply(n,l)}}return n.concat(o||[])},t.prototype.findMetadata=function(t,e,o){var s=t.get(e);if(s){var n=s.get(o);if(n)return n}for(var r=0,i=this.getAncestors(e);r<i.length;r++){var a=i[r],p=t.get(a);if(p){var l=p.get(o);if(l)return l}}},t.prototype.findMetadatas=function(t,e,o){var s,n=t.get(e);n&&(s=n.get(o));for(var r=[],i=0,a=this.getAncestors(e);i<a.length;i++){var p=a[i],l=t.get(p);l&&l.has(o)&&r.push.apply(r,l.get(o))}return r.slice().reverse().concat((s||[]).slice().reverse())},t.prototype.getAncestors=function(t){if(!t)return[];if(!this._ancestorsMap.has(t)){for(var e=[],o=Object.getPrototypeOf(t.prototype.constructor);void 0!==o.prototype;o=Object.getPrototypeOf(o.prototype.constructor))e.push(o);this._ancestorsMap.set(t,e)}return this._ancestorsMap.get(t)},t}()),i=function(t,e,o){if(o||2==arguments.length)for(var s,n=0,r=e.length;n<r;n++)!s&&n in e||(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return t.concat(s||Array.prototype.slice.call(e))},a=function(){function t(t,e){this.transformationType=t,this.options=e,this.recursionStack=new Set}return t.prototype.transform=function(t,e,n,i,a,p){var l=this;if(void 0===p&&(p=0),Array.isArray(e)||e instanceof Set){var c,d=i&&this.transformationType===o.PLAIN_TO_CLASS&&((c=new i)instanceof Set||"push"in c)?c:[];return e.forEach(function(e,s){var r=t?t[s]:void 0;if(l.options.enableCircularCheck&&l.isCircular(e))l.transformationType===o.CLASS_TO_CLASS&&(d instanceof Set?d.add(e):d.push(e));else{var i=void 0;if("function"!=typeof n&&n&&n.options&&n.options.discriminator&&n.options.discriminator.property&&n.options.discriminator.subTypes){if(l.transformationType===o.PLAIN_TO_CLASS){i=n.options.discriminator.subTypes.find(function(t){return t.name===e[n.options.discriminator.property]});var a=n.typeFunction({newObject:d,object:e,property:void 0});i=void 0===i?a:i.value,n.options.keepDiscriminatorProperty||delete e[n.options.discriminator.property]}l.transformationType===o.CLASS_TO_CLASS&&(i=e.constructor),l.transformationType===o.CLASS_TO_PLAIN&&(e[n.options.discriminator.property]=n.options.discriminator.subTypes.find(function(t){return t.value===e.constructor}).name)}else i=n;var c=l.transform(r,e,i,void 0,e instanceof Map,p+1);d instanceof Set?d.add(c):d.push(c)}}),d}if(n!==String||a)if(n===Number&&!a)return null==e?e:Number(e);else{if(n===Boolean&&!a)return null==e?e:!!e;if((n===Date||e instanceof Date)&&!a)return e instanceof Date?new Date(e.valueOf()):null==e?e:new Date(e);if(("undefined"!=typeof globalThis?globalThis:void 0!==s.g?s.g:"undefined"!=typeof window?window:"undefined"!=typeof self?self:void 0).Buffer&&(n===Buffer||e instanceof Buffer)&&!a)return null==e?e:Buffer.from(e);if(null!==e&&"object"==typeof e&&"function"==typeof e.then&&!a)return new Promise(function(t,o){e.then(function(e){return t(l.transform(void 0,e,n,void 0,void 0,p+1))},o)});if(!a&&null!==e&&"object"==typeof e&&"function"==typeof e.then||"object"!=typeof e||null===e)return e;!n&&e.constructor!==Object&&(Array.isArray(e)||e.constructor!==Array)&&(n=e.constructor),!n&&t&&(n=t.constructor),this.options.enableCircularCheck&&this.recursionStack.add(e);var u=this.getKeys(n,e,a),f=t||{};t||this.transformationType!==o.PLAIN_TO_CLASS&&this.transformationType!==o.CLASS_TO_CLASS||(f=a?new Map:n?new n:{});for(var h=this,y=0;y<u.length;y++)!function(s){if("__proto__"!==s&&"constructor"!==s){var i=s,l=s;if(!h.options.ignoreDecorators&&n){if(h.transformationType===o.PLAIN_TO_CLASS){var c=r.findExposeMetadataByCustomName(n,s);c&&(l=c.propertyName,i=c.propertyName)}else if(h.transformationType===o.CLASS_TO_PLAIN||h.transformationType===o.CLASS_TO_CLASS){var c=r.findExposeMetadata(n,s);c&&c.options&&c.options.name&&(i=c.options.name)}}var d=void 0;d=h.transformationType===o.PLAIN_TO_CLASS?e[s]:e instanceof Map?e.get(s):e[s]instanceof Function?e[s]():e[s];var u=void 0,y=d instanceof Map;if(n&&a)u=n;else if(n){var m=r.findTypeMetadata(n,l);if(m){var g={newObject:f,object:e,property:l},v=m.typeFunction?m.typeFunction(g):m.reflectedType;m.options&&m.options.discriminator&&m.options.discriminator.property&&m.options.discriminator.subTypes?e[s]instanceof Array?u=m:(h.transformationType===o.PLAIN_TO_CLASS&&(u=void 0===(u=m.options.discriminator.subTypes.find(function(t){if(d&&d instanceof Object&&m.options.discriminator.property in d)return t.name===d[m.options.discriminator.property]}))?v:u.value,!m.options.keepDiscriminatorProperty&&d&&d instanceof Object&&m.options.discriminator.property in d&&delete d[m.options.discriminator.property]),h.transformationType===o.CLASS_TO_CLASS&&(u=d.constructor),h.transformationType===o.CLASS_TO_PLAIN&&d&&(d[m.options.discriminator.property]=m.options.discriminator.subTypes.find(function(t){return t.value===d.constructor}).name)):u=v,y=y||m.reflectedType===Map}else if(h.options.targetMaps)h.options.targetMaps.filter(function(t){return t.target===n&&!!t.properties[l]}).forEach(function(t){return u=t.properties[l]});else if(h.options.enableImplicitConversion&&h.transformationType===o.PLAIN_TO_CLASS){var _=Reflect.getMetadata("design:type",n.prototype,l);_&&(u=_)}}var S=Array.isArray(e[s])?h.getReflectedType(n,l):void 0,T=t?t[s]:void 0;if(f.constructor.prototype){var w=Object.getOwnPropertyDescriptor(f.constructor.prototype,i);if((h.transformationType===o.PLAIN_TO_CLASS||h.transformationType===o.CLASS_TO_CLASS)&&(w&&!w.set||f[i]instanceof Function))return}if(h.options.enableCircularCheck&&h.isCircular(d)){if(h.transformationType===o.CLASS_TO_CLASS){var C=d;(void 0!==(C=h.applyCustomTransformations(C,n,s,e,h.transformationType))||h.options.exposeUnsetFields)&&(f instanceof Map?f.set(i,C):f[i]=C)}}else{var A=h.transformationType===o.PLAIN_TO_CLASS?i:s,C=void 0;h.transformationType===o.CLASS_TO_PLAIN?(C=e[A],C=h.applyCustomTransformations(C,n,A,e,h.transformationType),C=e[A]===C?d:C,C=h.transform(T,C,u,S,y,p+1)):void 0===d&&h.options.exposeDefaultValues?C=f[i]:(C=h.transform(T,d,u,S,y,p+1),C=h.applyCustomTransformations(C,n,A,e,h.transformationType)),(void 0!==C||h.options.exposeUnsetFields)&&(f instanceof Map?f.set(i,C):f[i]=C)}}}(u[y]);return this.options.enableCircularCheck&&this.recursionStack.delete(e),f}return null==e?e:String(e)},t.prototype.applyCustomTransformations=function(t,e,o,s,n){var i=this,a=r.findTransformMetadatas(e,o,this.transformationType);return void 0!==this.options.version&&(a=a.filter(function(t){return!t.options||i.checkVersion(t.options.since,t.options.until)})),(a=this.options.groups&&this.options.groups.length?a.filter(function(t){return!t.options||i.checkGroups(t.options.groups)}):a.filter(function(t){return!t.options||!t.options.groups||!t.options.groups.length})).forEach(function(e){t=e.transformFn({value:t,key:o,obj:s,type:n,options:i.options})}),t},t.prototype.isCircular=function(t){return this.recursionStack.has(t)},t.prototype.getReflectedType=function(t,e){if(t){var o=r.findTypeMetadata(t,e);return o?o.reflectedType:void 0}},t.prototype.getKeys=function(t,e,s){var n=this,a=r.getStrategy(t);"none"===a&&(a=this.options.strategy||"exposeAll");var p=[];if(("exposeAll"===a||s)&&(p=e instanceof Map?Array.from(e.keys()):Object.keys(e)),s)return p;if(this.options.ignoreDecorators&&this.options.excludeExtraneousValues&&t){var l=r.getExposedProperties(t,this.transformationType),c=r.getExcludedProperties(t,this.transformationType);p=i(i([],l,!0),c,!0)}if(!this.options.ignoreDecorators&&t){var l=r.getExposedProperties(t,this.transformationType);this.transformationType===o.PLAIN_TO_CLASS&&(l=l.map(function(e){var o=r.findExposeMetadata(t,e);return o&&o.options&&o.options.name?o.options.name:e})),p=this.options.excludeExtraneousValues?l:p.concat(l);var d=r.getExcludedProperties(t,this.transformationType);d.length>0&&(p=p.filter(function(t){return!d.includes(t)})),void 0!==this.options.version&&(p=p.filter(function(e){var o=r.findExposeMetadata(t,e);return!o||!o.options||n.checkVersion(o.options.since,o.options.until)})),p=this.options.groups&&this.options.groups.length?p.filter(function(e){var o=r.findExposeMetadata(t,e);return!o||!o.options||n.checkGroups(o.options.groups)}):p.filter(function(e){var o=r.findExposeMetadata(t,e);return!o||!o.options||!o.options.groups||!o.options.groups.length})}return this.options.excludePrefixes&&this.options.excludePrefixes.length&&(p=p.filter(function(t){return n.options.excludePrefixes.every(function(e){return t.substr(0,e.length)!==e})})),p=p.filter(function(t,e,o){return o.indexOf(t)===e})},t.prototype.checkVersion=function(t,e){var o=!0;return t&&(o=this.options.version>=t),o&&e&&(o=this.options.version<e),o},t.prototype.checkGroups=function(t){return!t||this.options.groups.some(function(e){return t.includes(e)})},t}(),p={enableCircularCheck:!1,enableImplicitConversion:!1,excludeExtraneousValues:!1,excludePrefixes:void 0,exposeDefaultValues:!1,exposeUnsetFields:!0,groups:void 0,ignoreDecorators:!1,strategy:void 0,targetMaps:void 0,version:void 0},l=function(){return(l=Object.assign||function(t){for(var e,o=1,s=arguments.length;o<s;o++)for(var n in e=arguments[o])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},c=new(function(){function t(){}return t.prototype.instanceToPlain=function(t,e){return new a(o.CLASS_TO_PLAIN,l(l({},p),e)).transform(void 0,t,void 0,void 0,void 0,void 0)},t.prototype.classToPlainFromExist=function(t,e,s){return new a(o.CLASS_TO_PLAIN,l(l({},p),s)).transform(e,t,void 0,void 0,void 0,void 0)},t.prototype.plainToInstance=function(t,e,s){return new a(o.PLAIN_TO_CLASS,l(l({},p),s)).transform(void 0,e,t,void 0,void 0,void 0)},t.prototype.plainToClassFromExist=function(t,e,s){return new a(o.PLAIN_TO_CLASS,l(l({},p),s)).transform(t,e,void 0,void 0,void 0,void 0)},t.prototype.instanceToInstance=function(t,e){return new a(o.CLASS_TO_CLASS,l(l({},p),e)).transform(void 0,t,void 0,void 0,void 0,void 0)},t.prototype.classToClassFromExist=function(t,e,s){return new a(o.CLASS_TO_CLASS,l(l({},p),s)).transform(e,t,void 0,void 0,void 0,void 0)},t.prototype.serialize=function(t,e){return JSON.stringify(this.instanceToPlain(t,e))},t.prototype.deserialize=function(t,e,o){var s=JSON.parse(e);return this.plainToInstance(t,s,o)},t.prototype.deserializeArray=function(t,e,o){var s=JSON.parse(e);return this.plainToInstance(t,s,o)},t}());function d(t,e){return c.instanceToPlain(t,e)}function u(t,e,o){return c.plainToInstance(t,e,o)}let f="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),h=new Uint8Array(16),y=[];for(let t=0;t<256;++t)y.push((t+256).toString(16).slice(1));let m=function(e,o,s){if(f&&!o&&!e)return f();var n=e,r=s;let i=(n=n||{}).random??n.rng?.()??function(){if(!t){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");t=crypto.getRandomValues.bind(crypto)}return t(h)}();if(i.length<16)throw Error("Random bytes length must be >= 16");if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,o){if((r=r||0)<0||r+16>o.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let t=0;t<16;++t)o[r+t]=i[t];return o}return function(t,e=0){return(y[t[e+0]]+y[t[e+1]]+y[t[e+2]]+y[t[e+3]]+"-"+y[t[e+4]]+y[t[e+5]]+"-"+y[t[e+6]]+y[t[e+7]]+"-"+y[t[e+8]]+y[t[e+9]]+"-"+y[t[e+10]]+y[t[e+11]]+y[t[e+12]]+y[t[e+13]]+y[t[e+14]]+y[t[e+15]]).toLowerCase()}(i)};function g(t,e){return!!e&&e instanceof t}class v{components=new Map;add=t=>{this.components.set(t.constructor.name,t)};update=(t,e)=>{let o=this.components.get(t.name);if(g(t,o)){let s=e(o);this.components.set(t.name,s)}};remove=t=>{this.components.delete(t.name)};get=t=>{let e=this.components.get(t.name);if(g(t,e))return e;throw Error(`ComponentCollection does not have component of type ${t.name}`)};has=t=>Array.isArray(t)?t.every(t=>!0===this.components.has(t.name)):this.components.has(t.name);hasSome=t=>t.some(t=>!0===this.components.has(t.name));hasByName=t=>Array.isArray(t)?t.every(t=>!0===this.components.has(t)):this.components.has(t);get componentTypes(){return[...this.components.keys()]}get size(){return this.components.size}[Symbol.iterator](){return this.components.values()}toDevComponents(){let t={};for(let[e,o]of this.components)t[e]=o;return t}}let _=class{id;components;tags;systems=[];state;constructor(t,e){this.id=t.id,this.components=t.components.toDevComponents(),this.tags=[...t.tags],this.state=t.state;const o=Object.keys(this.components);for(const[t,s]of e.systems.compNamesBySystemName)s.every(t=>o.includes(t))&&this.systems.push(t)}toTableRow(){return{id:this.id,components:Object.keys(this.components).join(", "),tags:this.tags.join(", "),systems:this.systems.join(", ")}}};class S{current;inital;transitions;constructor(t,e){this.inital=t,this.current=t,this.transitions=e}next(t){this.transitions[this.current]&&(this.current=this.transitions[this.current](t,this.current))}reset(){this.current=this.inital}is(t){return this.current===t}}class T{_id;_world;_error;_state;get id(){return this._id}get world(){return this._world}get state(){return this._state.current}constructor(t){this._id=m(),this._world=t,this._error=null;const e=t=>"error"===t||this._error?"error":t;this._state=new S("creating",{creating:e,created:e,destroying:e,destroyed:()=>"destroyed",error:()=>"error"}),this._world.registerEntity(this),0===this._world.systems.compNamesBySystemName.size&&this._state.next("created")}onCreate(t){}onDestroy(t){}onComponentAdd(t){}onTrackedComponentUpdate(t){}onComponentRemove(t){}add(t){if(!t)throw Error("Entity.add: Component is null or undefined");return this._world.add(this._id,t),this}addTag(t){let e=this._world.entitiesByTags.has(t)?this._world.entitiesByTags.get(t):new Set;return e&&(e.add(this._id),this._world.entitiesByTags.set(t,e)),this}has(t){return(this._world.componentCollections.get(this._id)||new v).has(t)}hasSome(t){return(this._world.componentCollections.get(this._id)||new v).has(t)}hasTag(t){if(this._world.entitiesByTags.has(t)){let e=this._world.entitiesByTags.get(t);if(e)return e.has(this._id)}return!1}get(t){return(this._world.componentCollections.get(this._id)||new v).get(t)}getAll(){return this._world.componentCollections.get(this._id)||new v}remove(t){return this._world.remove(this._id,t),this}removeTag(t){if(this._world.entitiesByTags.has(t)){let e=this._world.entitiesByTags.get(t);e&&(e.delete(this._id),0===e.size&&this._world.entitiesByTags.delete(t))}return this}clear(){return this._world.clearEntityComponents(this._id),this}clearTags(){for(let[t,e]of this._world.entitiesByTags.entries())e.delete(this._id),0===e.size&&this._world.entitiesByTags.delete(t);return this}finishCreation(){this._state.next("created")}destroy(){0===this._world.systems.compNamesBySystemName.size?this.destroyImmediately():this._state.next("destroying")}destroyImmediately(){this.onDestroy(this._world),this._world.destroyEntity(this._id),this._state.next("destroyed")}get components(){return this._world.componentCollections.get(this._id)||new v}get tags(){let t=new Set;for(let[e,o]of this._world.entitiesByTags.entries())o.has(this._id)&&t.add(e);return t}toDevEntity(){return new _(this,this._world)}}let w=class{world;constructor(t){this.world=t}get systemComponents(){let t=[];for(let[e,o]of this.world.systems.compNamesBySystemName)t.push({system:e,components:o.join(", ")});return t}get entities(){return[...this.world.entities.values()].map(t=>t.toDevEntity())}},C="__DEFAULT__";class A{world;compNamesBySystemName;phases=new Map;phaseOrder=["Input","Logic","Events","Render","Cleanup"];constructor(t){this.world=t,this.compNamesBySystemName=new Map,this.phases.set(C,[])}setPhaseOrder(t){this.phaseOrder=t}add(t,e,o,s={}){let n=t.map(t=>t.name),{phase:r=C,name:i}=s,a=i||e.name||o;return this.phases.has(r)||this.phases.set(r,[]),this.phases.get(r)?.push({func:e,name:a,key:o}),this.compNamesBySystemName.set(a,n),this.world.entitiesByCTypes.has(o)||this.world.entitiesByCTypes.set(o,new Set),this}run(){let t=(this.phases.get(C)||[]).length>0,e=Array.from(this.phases.keys()).some(t=>t!==C&&(this.phases.get(t)?.length??0)>0);if(t&&e)throw Error("Ambiguous system execution order: Some systems are registered with a phase, while others are not. Please assign a phase to all systems if you intend to use execution phases.");let o=[],s=[];for(let t of this.world.entities.values())"creating"===t.state?o.push(t):"destroying"===t.state&&s.push(t);let n=e?this.phaseOrder:[C];for(let t of this.phases.keys())t===C||n.includes(t)||n.push(t);for(let t of n){for(let{func:e,key:o}of this.phases.get(t)||[]){let t=this.world.entitiesByCTypes.get(o)||new Set,s=t.size;if(0===s)continue;let n=0;for(let o of t){let t=this.world.entities.get(o);t&&"destroyed"!==t.state&&(e({entity:t,components:this.world.componentCollections.get(o)||new v,world:this.world,index:n,size:s,isFirst:0===n,isLast:n+1===s}),n++)}}this.world.events.processQueueForPhase(t)}for(let t of o)t.finishCreation();for(let t of s)t.destroyImmediately()}}let M={isTracked:Symbol.for("ecs.trackedComponent.isTracked"),world:Symbol.for("ecs.trackedComponent.world"),entityIDs:Symbol.for("ecs.trackedComponent.entityIDs"),getEntities:Symbol.for("ecs.trackedComponent.getEntities"),setWorld:Symbol.for("ecs.trackedComponent.setWorld"),onAdd:Symbol.for("ecs.trackedComponent.onAdd"),onUpdate:Symbol.for("ecs.trackedComponent.onUpdate"),onRemove:Symbol.for("ecs.trackedComponent.onRemove")};function O(t,e){return new Proxy(t,{construct(t,o){let s,n=new t(...o);return n[M.isTracked]=!0,n[M.setWorld]=t=>{n[M.world]=t},n[M.entityIDs]=new Set,n[M.getEntities]=t=>{let e=new Map;for(let o of n[M.entityIDs]){let s=t.entities.get(o);s&&e.set(o,s)}return e},n[M.onAdd]=(t,o)=>{if(e.onAdd){let s=n[M.getEntities](t);e.onAdd({component:n,world:t,entity:o,entities:s})}},n[M.onRemove]=(t,o)=>{if(e.onRemove){let s=n[M.getEntities](t);e.onRemove({component:n,world:t,entity:o,entities:s})}},new Proxy(n,(s=new Set,{set(t,o,n){s.add(o);let r=t[M.world],i=t[o];t[o]=n;let a=t[M.getEntities](r);for(let e of a.values())e.onTrackedComponentUpdate({world:r,component:t});return e.onUpdate&&e.onUpdate({entities:a,world:r,component:t,previousVal:i,property:o}),!0}}))}})}class L{world;listeners=new Map;queue=[];constructor(t){this.world=t}addListener(t,e,o){this.listeners.has(t)||this.listeners.set(t,[]);let s=this.listeners.get(t);s&&s.push({func:e,phase:o})}emit(t){this.queue.push(t)}processQueueForPhase(t){for(let e of[...this.queue]){let o=e.constructor;for(let s of this.listeners.get(o)||[])s.phase===t&&s.func({event:e,world:this.world})}}clearQueue(){this.queue=[]}}class b{componentCollections=new Map;entities=new Map;entitiesByCTypes=new Map;entitiesByTags=new Map;systems;dev;events;componentToSystemQueries=new Map;resources=new Map;prefabs=new Map;constructor(){this.dev=new w(this),this.systems=new A(this),this.events=new L(this)}addSystemListener(t,e,o={}){let{phase:s="Events"}=o;return this.events.addListener(t,e,s),this}setResource(t){return this.resources.set(t.constructor,t),this}getResource(t){return this.resources.get(t)}hasResource(t){return this.resources.has(t)}removeResource(t){return this.resources.delete(t)}registerPrefab(t,e){return this.prefabs.set(t,e),this}createEntityFromPrefab(t,e={}){let o=this.prefabs.get(t);if(!o)throw Error(`Prefab with name "${t}" not found.`);let s=this.createEntity();if(o.tags)for(let t of o.tags)s.addTag(t);for(let t of o.components){let o=JSON.parse(JSON.stringify(t));Object.setPrototypeOf(o,t.constructor.prototype);let n=t.constructor.name;e[n]&&Object.assign(o,e[n]),s.add(o)}return s}setPhaseOrder(t){return this.systems.setPhaseOrder(t),this}find=t=>{for(let e of this.entities.values())if(t(e))return e;return null};findAll=t=>{let e=[];for(let o of this.entities.values())t(o)&&e.push(o);return e};locate=t=>{for(let e of this.entities.values())if(e.components.has(t))return e;return null};locateAll=t=>{let e=[];for(let o of this.entities.values())o.components.has(t)&&e.push(o);return e};grab=t=>{let e=this.locate(t);if(e){let o=(this.componentCollections.get(e.id)||new v).get(t);return{entity:e,component:o}}return null};grabBy=(t,e)=>{for(let o of this.locateAll(t)){let s=(this.componentCollections.get(o.id)||new v).get(t);if(e(s))return{component:s,entity:o}}return null};grabAll=t=>this.locateAll(t).map(e=>({entity:e,component:e.components.get(t)}));get=(t,e)=>(this.componentCollections.get(t)||new v).get(e);getComponent=(t,e)=>{let o=this.grab(t);return o?o.component:e||null};getTagged=t=>{let e=this.entitiesByTags.get(t);if(e){let t=e.values().next().value;if(t){let e=this.entities.get(t);if(e)return e}}return null};getAllTagged=t=>{let e=[],o=this.entitiesByTags.get(t);if(o)for(let t of o){let o=this.entities.get(t);o&&e.push(o)}return e};add=(t,e)=>{let o=this.componentCollections.get(t)||new v,s=this.entities.get(t);if(!s)throw Error(`world.add: Unable to locate entity with id ${t}`);for(let[s,n]of(o.add(e),this.componentCollections.set(t,o),this.entitiesByCTypes))s.split(",").every(t=>o.hasByName(t))&&n.add(t);return e[M.isTracked]&&(e[M.setWorld](this),e[M.entityIDs].add(t),e[M.onAdd](this,s)),e.onAdd&&e.onAdd({world:this,entity:s,component:e}),s.onComponentAdd({world:this,component:e}),this};remove=(t,e)=>{let o=this.componentCollections.get(t);if(!o)return this;let s=e.name;if(!o.hasByName(s))return this;let n=o.get(e),r=this.entities.get(t);if(!r)return this;for(let e of(n.onRemove&&n.onRemove({world:this,entity:r,component:n}),n[M.isTracked]&&(n[M.entityIDs].delete(t),n[M.onRemove](this,r)),this.componentToSystemQueries.get(s)||[])){let o=this.entitiesByCTypes.get(e);o&&o.delete(t)}for(let[s,n]of(o.remove(e),this.entitiesByCTypes.entries()))s.split(",").every(t=>o.hasByName(t))&&n.add(t);return r.onComponentRemove({world:this,component:n}),this};addSystem(t,e,o={}){let s=t.map(t=>t.name).sort(),n=s.join(",");for(let t of s){let e=this.componentToSystemQueries.get(t)||[];e.includes(n)||e.push(n),this.componentToSystemQueries.set(t,e)}return this.systems.add(t,e,n,o),this}registerEntity(t){let e=new v;return this.componentCollections.set(t.id,e),this.entities.set(t.id,t),t.onCreate(this),this}clearEntityComponents(t){for(let e of(this.componentCollections.set(t,new v),this.entitiesByCTypes.values()))e.has(t)&&e.delete(t);return this}createEntity(){return new T(this)}destroyEntity(t){if(this.componentCollections.delete(t),!this.entities.get(t))throw Error(`world.destroyEntity: No entity found. entity id: ${t}`);for(let e of(this.entities.delete(t),this.entitiesByCTypes.values()))e.has(t)&&e.delete(t);for(let[e,o]of this.entitiesByTags)o.has(t)&&o.delete(t),0===o.size&&this.entitiesByTags.delete(e);return this}toJSON(){let t={resources:[],entities:[]};for(let[e,o]of this.resources.entries()){let s=o.toJSON?o.toJSON():d(o);t.resources.push({name:e.name,data:s})}for(let e of this.entities.values()){let o=[],s=this.componentCollections.get(e.id);if(s)for(let t of s){let e=t.toJSON?t.toJSON():d(t);o.push({name:t.constructor.name,data:e})}t.entities.push({id:e.id,tags:Array.from(e.tags),components:o})}return t}static fromJSON(t,e){let o=new b;for(let s of t.resources){let t=e.resources[s.name];if(!t)throw Error(`Cannot hydrate resource: Class constructor for "${s.name}" not found in typeMapping.resources.`);let n=t.fromJSON?t.fromJSON(s.data):u(t,s.data);o.setResource(n)}for(let s of t.entities){let t=o.createEntity();for(let e of s.tags)t.addTag(e);for(let o of s.components){let s=e.components[o.name];if(!s)throw Error(`Cannot hydrate component: Class constructor for "${o.name}" not found in typeMapping.components.`);let n=s.fromJSON?s.fromJSON(o.data):u(s,o.data);t.add(n)}}return o}}module.exports=n})();