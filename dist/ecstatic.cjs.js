(()=>{"use strict";var t,e,o={};o.d=(t,e)=>{for(var s in e)o.o(e,s)&&!o.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},o.g=(()=>{if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(t){if("object"==typeof window)return window}})(),o.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),o.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var s={};o.r(s),o.d(s,{Entity:()=>m,World:()=>A,trackComponent:()=>w}),(t=e||(e={}))[t.PLAIN_TO_CLASS=0]="PLAIN_TO_CLASS",t[t.CLASS_TO_PLAIN=1]="CLASS_TO_PLAIN",t[t.CLASS_TO_CLASS=2]="CLASS_TO_CLASS";var n=new(function(){function t(){this._typeMetadatas=new Map,this._transformMetadatas=new Map,this._exposeMetadatas=new Map,this._excludeMetadatas=new Map,this._ancestorsMap=new Map}return t.prototype.addTypeMetadata=function(t){this._typeMetadatas.has(t.target)||this._typeMetadatas.set(t.target,new Map),this._typeMetadatas.get(t.target).set(t.propertyName,t)},t.prototype.addTransformMetadata=function(t){this._transformMetadatas.has(t.target)||this._transformMetadatas.set(t.target,new Map),this._transformMetadatas.get(t.target).has(t.propertyName)||this._transformMetadatas.get(t.target).set(t.propertyName,[]),this._transformMetadatas.get(t.target).get(t.propertyName).push(t)},t.prototype.addExposeMetadata=function(t){this._exposeMetadatas.has(t.target)||this._exposeMetadatas.set(t.target,new Map),this._exposeMetadatas.get(t.target).set(t.propertyName,t)},t.prototype.addExcludeMetadata=function(t){this._excludeMetadatas.has(t.target)||this._excludeMetadatas.set(t.target,new Map),this._excludeMetadatas.get(t.target).set(t.propertyName,t)},t.prototype.findTransformMetadatas=function(t,o,s){return this.findMetadatas(this._transformMetadatas,t,o).filter(function(t){return!t.options||!0===t.options.toClassOnly&&!0===t.options.toPlainOnly||(!0===t.options.toClassOnly?s===e.CLASS_TO_CLASS||s===e.PLAIN_TO_CLASS:!0!==t.options.toPlainOnly||s===e.CLASS_TO_PLAIN)})},t.prototype.findExcludeMetadata=function(t,e){return this.findMetadata(this._excludeMetadatas,t,e)},t.prototype.findExposeMetadata=function(t,e){return this.findMetadata(this._exposeMetadatas,t,e)},t.prototype.findExposeMetadataByCustomName=function(t,e){return this.getExposedMetadatas(t).find(function(t){return t.options&&t.options.name===e})},t.prototype.findTypeMetadata=function(t,e){return this.findMetadata(this._typeMetadatas,t,e)},t.prototype.getStrategy=function(t){var e=this._excludeMetadatas.get(t),o=e&&e.get(void 0),s=this._exposeMetadatas.get(t),n=s&&s.get(void 0);return o&&n||!o&&!n?"none":o?"excludeAll":"exposeAll"},t.prototype.getExposedMetadatas=function(t){return this.getMetadata(this._exposeMetadatas,t)},t.prototype.getExcludedMetadatas=function(t){return this.getMetadata(this._excludeMetadatas,t)},t.prototype.getExposedProperties=function(t,o){return this.getExposedMetadatas(t).filter(function(t){return!t.options||!0===t.options.toClassOnly&&!0===t.options.toPlainOnly||(!0===t.options.toClassOnly?o===e.CLASS_TO_CLASS||o===e.PLAIN_TO_CLASS:!0!==t.options.toPlainOnly||o===e.CLASS_TO_PLAIN)}).map(function(t){return t.propertyName})},t.prototype.getExcludedProperties=function(t,o){return this.getExcludedMetadatas(t).filter(function(t){return!t.options||!0===t.options.toClassOnly&&!0===t.options.toPlainOnly||(!0===t.options.toClassOnly?o===e.CLASS_TO_CLASS||o===e.PLAIN_TO_CLASS:!0!==t.options.toPlainOnly||o===e.CLASS_TO_PLAIN)}).map(function(t){return t.propertyName})},t.prototype.clear=function(){this._typeMetadatas.clear(),this._exposeMetadatas.clear(),this._excludeMetadatas.clear(),this._ancestorsMap.clear()},t.prototype.getMetadata=function(t,e){var o,s=t.get(e);s&&(o=Array.from(s.values()).filter(function(t){return void 0!==t.propertyName}));for(var n=[],r=0,i=this.getAncestors(e);r<i.length;r++){var a=i[r],p=t.get(a);if(p){var l=Array.from(p.values()).filter(function(t){return void 0!==t.propertyName});n.push.apply(n,l)}}return n.concat(o||[])},t.prototype.findMetadata=function(t,e,o){var s=t.get(e);if(s){var n=s.get(o);if(n)return n}for(var r=0,i=this.getAncestors(e);r<i.length;r++){var a=i[r],p=t.get(a);if(p){var l=p.get(o);if(l)return l}}},t.prototype.findMetadatas=function(t,e,o){var s,n=t.get(e);n&&(s=n.get(o));for(var r=[],i=0,a=this.getAncestors(e);i<a.length;i++){var p=a[i],l=t.get(p);l&&l.has(o)&&r.push.apply(r,l.get(o))}return r.slice().reverse().concat((s||[]).slice().reverse())},t.prototype.getAncestors=function(t){if(!t)return[];if(!this._ancestorsMap.has(t)){for(var e=[],o=Object.getPrototypeOf(t.prototype.constructor);void 0!==o.prototype;o=Object.getPrototypeOf(o.prototype.constructor))e.push(o);this._ancestorsMap.set(t,e)}return this._ancestorsMap.get(t)},t}()),r=function(t,e,o){if(o||2==arguments.length)for(var s,n=0,r=e.length;n<r;n++)!s&&n in e||(s||(s=Array.prototype.slice.call(e,0,n)),s[n]=e[n]);return t.concat(s||Array.prototype.slice.call(e))},i=function(){function t(t,e){this.transformationType=t,this.options=e,this.recursionStack=new Set}return t.prototype.transform=function(t,s,r,i,a,p){var l=this;if(void 0===p&&(p=0),Array.isArray(s)||s instanceof Set){var c,d=i&&this.transformationType===e.PLAIN_TO_CLASS&&((c=new i)instanceof Set||"push"in c)?c:[];return s.forEach(function(o,s){var n=t?t[s]:void 0;if(l.options.enableCircularCheck&&l.isCircular(o))l.transformationType===e.CLASS_TO_CLASS&&(d instanceof Set?d.add(o):d.push(o));else{var i=void 0;if("function"!=typeof r&&r&&r.options&&r.options.discriminator&&r.options.discriminator.property&&r.options.discriminator.subTypes){if(l.transformationType===e.PLAIN_TO_CLASS){i=r.options.discriminator.subTypes.find(function(t){return t.name===o[r.options.discriminator.property]});var a=r.typeFunction({newObject:d,object:o,property:void 0});i=void 0===i?a:i.value,r.options.keepDiscriminatorProperty||delete o[r.options.discriminator.property]}l.transformationType===e.CLASS_TO_CLASS&&(i=o.constructor),l.transformationType===e.CLASS_TO_PLAIN&&(o[r.options.discriminator.property]=r.options.discriminator.subTypes.find(function(t){return t.value===o.constructor}).name)}else i=r;var c=l.transform(n,o,i,void 0,o instanceof Map,p+1);d instanceof Set?d.add(c):d.push(c)}}),d}if(r!==String||a)if(r===Number&&!a)return null==s?s:Number(s);else{if(r===Boolean&&!a)return null==s?s:!!s;if((r===Date||s instanceof Date)&&!a)return s instanceof Date?new Date(s.valueOf()):null==s?s:new Date(s);if(("undefined"!=typeof globalThis?globalThis:void 0!==o.g?o.g:"undefined"!=typeof window?window:"undefined"!=typeof self?self:void 0).Buffer&&(r===Buffer||s instanceof Buffer)&&!a)return null==s?s:Buffer.from(s);if(null!==s&&"object"==typeof s&&"function"==typeof s.then&&!a)return new Promise(function(t,e){s.then(function(e){return t(l.transform(void 0,e,r,void 0,void 0,p+1))},e)});if(!a&&null!==s&&"object"==typeof s&&"function"==typeof s.then||"object"!=typeof s||null===s)return s;!r&&s.constructor!==Object&&(Array.isArray(s)||s.constructor!==Array)&&(r=s.constructor),!r&&t&&(r=t.constructor),this.options.enableCircularCheck&&this.recursionStack.add(s);var u=this.getKeys(r,s,a),f=t||{};t||this.transformationType!==e.PLAIN_TO_CLASS&&this.transformationType!==e.CLASS_TO_CLASS||(f=a?new Map:r?new r:{});for(var h=this,y=0;y<u.length;y++)!function(o){if("__proto__"!==o&&"constructor"!==o){var i=o,l=o;if(!h.options.ignoreDecorators&&r){if(h.transformationType===e.PLAIN_TO_CLASS){var c=n.findExposeMetadataByCustomName(r,o);c&&(l=c.propertyName,i=c.propertyName)}else if(h.transformationType===e.CLASS_TO_PLAIN||h.transformationType===e.CLASS_TO_CLASS){var c=n.findExposeMetadata(r,o);c&&c.options&&c.options.name&&(i=c.options.name)}}var d=void 0;d=h.transformationType===e.PLAIN_TO_CLASS?s[o]:s instanceof Map?s.get(o):s[o]instanceof Function?s[o]():s[o];var u=void 0,y=d instanceof Map;if(r&&a)u=r;else if(r){var m=n.findTypeMetadata(r,l);if(m){var g={newObject:f,object:s,property:l},v=m.typeFunction?m.typeFunction(g):m.reflectedType;m.options&&m.options.discriminator&&m.options.discriminator.property&&m.options.discriminator.subTypes?s[o]instanceof Array?u=m:(h.transformationType===e.PLAIN_TO_CLASS&&(u=void 0===(u=m.options.discriminator.subTypes.find(function(t){if(d&&d instanceof Object&&m.options.discriminator.property in d)return t.name===d[m.options.discriminator.property]}))?v:u.value,!m.options.keepDiscriminatorProperty&&d&&d instanceof Object&&m.options.discriminator.property in d&&delete d[m.options.discriminator.property]),h.transformationType===e.CLASS_TO_CLASS&&(u=d.constructor),h.transformationType===e.CLASS_TO_PLAIN&&d&&(d[m.options.discriminator.property]=m.options.discriminator.subTypes.find(function(t){return t.value===d.constructor}).name)):u=v,y=y||m.reflectedType===Map}else if(h.options.targetMaps)h.options.targetMaps.filter(function(t){return t.target===r&&!!t.properties[l]}).forEach(function(t){return u=t.properties[l]});else if(h.options.enableImplicitConversion&&h.transformationType===e.PLAIN_TO_CLASS){var S=Reflect.getMetadata("design:type",r.prototype,l);S&&(u=S)}}var T=Array.isArray(s[o])?h.getReflectedType(r,l):void 0,w=t?t[o]:void 0;if(f.constructor.prototype){var C=Object.getOwnPropertyDescriptor(f.constructor.prototype,i);if((h.transformationType===e.PLAIN_TO_CLASS||h.transformationType===e.CLASS_TO_CLASS)&&(C&&!C.set||f[i]instanceof Function))return}if(h.options.enableCircularCheck&&h.isCircular(d)){if(h.transformationType===e.CLASS_TO_CLASS){var A=d;(void 0!==(A=h.applyCustomTransformations(A,r,o,s,h.transformationType))||h.options.exposeUnsetFields)&&(f instanceof Map?f.set(i,A):f[i]=A)}}else{var _=h.transformationType===e.PLAIN_TO_CLASS?i:o,A=void 0;h.transformationType===e.CLASS_TO_PLAIN?(A=s[_],A=h.applyCustomTransformations(A,r,_,s,h.transformationType),A=s[_]===A?d:A,A=h.transform(w,A,u,T,y,p+1)):void 0===d&&h.options.exposeDefaultValues?A=f[i]:(A=h.transform(w,d,u,T,y,p+1),A=h.applyCustomTransformations(A,r,_,s,h.transformationType)),(void 0!==A||h.options.exposeUnsetFields)&&(f instanceof Map?f.set(i,A):f[i]=A)}}}(u[y]);return this.options.enableCircularCheck&&this.recursionStack.delete(s),f}return null==s?s:String(s)},t.prototype.applyCustomTransformations=function(t,e,o,s,r){var i=this,a=n.findTransformMetadatas(e,o,this.transformationType);return void 0!==this.options.version&&(a=a.filter(function(t){return!t.options||i.checkVersion(t.options.since,t.options.until)})),(a=this.options.groups&&this.options.groups.length?a.filter(function(t){return!t.options||i.checkGroups(t.options.groups)}):a.filter(function(t){return!t.options||!t.options.groups||!t.options.groups.length})).forEach(function(e){t=e.transformFn({value:t,key:o,obj:s,type:r,options:i.options})}),t},t.prototype.isCircular=function(t){return this.recursionStack.has(t)},t.prototype.getReflectedType=function(t,e){if(t){var o=n.findTypeMetadata(t,e);return o?o.reflectedType:void 0}},t.prototype.getKeys=function(t,o,s){var i=this,a=n.getStrategy(t);"none"===a&&(a=this.options.strategy||"exposeAll");var p=[];if(("exposeAll"===a||s)&&(p=o instanceof Map?Array.from(o.keys()):Object.keys(o)),s)return p;if(this.options.ignoreDecorators&&this.options.excludeExtraneousValues&&t){var l=n.getExposedProperties(t,this.transformationType),c=n.getExcludedProperties(t,this.transformationType);p=r(r([],l,!0),c,!0)}if(!this.options.ignoreDecorators&&t){var l=n.getExposedProperties(t,this.transformationType);this.transformationType===e.PLAIN_TO_CLASS&&(l=l.map(function(e){var o=n.findExposeMetadata(t,e);return o&&o.options&&o.options.name?o.options.name:e})),p=this.options.excludeExtraneousValues?l:p.concat(l);var d=n.getExcludedProperties(t,this.transformationType);d.length>0&&(p=p.filter(function(t){return!d.includes(t)})),void 0!==this.options.version&&(p=p.filter(function(e){var o=n.findExposeMetadata(t,e);return!o||!o.options||i.checkVersion(o.options.since,o.options.until)})),p=this.options.groups&&this.options.groups.length?p.filter(function(e){var o=n.findExposeMetadata(t,e);return!o||!o.options||i.checkGroups(o.options.groups)}):p.filter(function(e){var o=n.findExposeMetadata(t,e);return!o||!o.options||!o.options.groups||!o.options.groups.length})}return this.options.excludePrefixes&&this.options.excludePrefixes.length&&(p=p.filter(function(t){return i.options.excludePrefixes.every(function(e){return t.substr(0,e.length)!==e})})),p=p.filter(function(t,e,o){return o.indexOf(t)===e})},t.prototype.checkVersion=function(t,e){var o=!0;return t&&(o=this.options.version>=t),o&&e&&(o=this.options.version<e),o},t.prototype.checkGroups=function(t){return!t||this.options.groups.some(function(e){return t.includes(e)})},t}(),a={enableCircularCheck:!1,enableImplicitConversion:!1,excludeExtraneousValues:!1,excludePrefixes:void 0,exposeDefaultValues:!1,exposeUnsetFields:!0,groups:void 0,ignoreDecorators:!1,strategy:void 0,targetMaps:void 0,version:void 0},p=function(){return(p=Object.assign||function(t){for(var e,o=1,s=arguments.length;o<s;o++)for(var n in e=arguments[o])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)},l=new(function(){function t(){}return t.prototype.instanceToPlain=function(t,o){return new i(e.CLASS_TO_PLAIN,p(p({},a),o)).transform(void 0,t,void 0,void 0,void 0,void 0)},t.prototype.classToPlainFromExist=function(t,o,s){return new i(e.CLASS_TO_PLAIN,p(p({},a),s)).transform(o,t,void 0,void 0,void 0,void 0)},t.prototype.plainToInstance=function(t,o,s){return new i(e.PLAIN_TO_CLASS,p(p({},a),s)).transform(void 0,o,t,void 0,void 0,void 0)},t.prototype.plainToClassFromExist=function(t,o,s){return new i(e.PLAIN_TO_CLASS,p(p({},a),s)).transform(t,o,void 0,void 0,void 0,void 0)},t.prototype.instanceToInstance=function(t,o){return new i(e.CLASS_TO_CLASS,p(p({},a),o)).transform(void 0,t,void 0,void 0,void 0,void 0)},t.prototype.classToClassFromExist=function(t,o,s){return new i(e.CLASS_TO_CLASS,p(p({},a),s)).transform(o,t,void 0,void 0,void 0,void 0)},t.prototype.serialize=function(t,e){return JSON.stringify(this.instanceToPlain(t,e))},t.prototype.deserialize=function(t,e,o){var s=JSON.parse(e);return this.plainToInstance(t,s,o)},t.prototype.deserializeArray=function(t,e,o){var s=JSON.parse(e);return this.plainToInstance(t,s,o)},t}());function c(t,e){return l.instanceToPlain(t,e)}function d(t,e,o){return l.plainToInstance(t,e,o)}function u(t,e){return!!e&&e instanceof t}class f{components=new Map;add=t=>{this.components.set(t.constructor.name,t)};update=(t,e)=>{let o=this.components.get(t.name);if(u(t,o)){let s=e(o);this.components.set(t.name,s)}};remove=t=>{this.components.delete(t.name)};get=t=>{let e=this.components.get(t.name);if(u(t,e))return e;throw Error(`ComponentCollection does not have component of type ${t.name}`)};has=t=>Array.isArray(t)?t.every(t=>!0===this.components.has(t.name)):this.components.has(t.name);hasSome=t=>t.some(t=>!0===this.components.has(t.name));hasByName=t=>Array.isArray(t)?t.every(t=>!0===this.components.has(t)):this.components.has(t);get componentTypes(){return[...this.components.keys()]}get size(){return this.components.size}[Symbol.iterator](){return this.components.values()}toDevComponents(){let t={};for(let[e,o]of this.components)t[e]=o;return t}}let h=class{id;components;tags;systems=[];state;constructor(t,e){this.id=t.id,this.components=t.components.toDevComponents(),this.tags=[...t.tags],this.state=t.state;const o=Object.keys(this.components);for(const[t,s]of e.systems.compNamesBySystemName)s.every(t=>o.includes(t))&&this.systems.push(t)}toTableRow(){return{id:this.id,components:Object.keys(this.components).join(", "),tags:this.tags.join(", "),systems:this.systems.join(", ")}}};class y{current;inital;transitions;constructor(t,e){this.inital=t,this.current=t,this.transitions=e}next(t){this.transitions[this.current]&&(this.current=this.transitions[this.current](t,this.current))}reset(){this.current=this.inital}is(t){return this.current===t}}class m{#t;#e;#o;#s;get id(){return this.#t}get world(){return this.#e}get state(){return this.#s.current}constructor(t,e){this.#t=e,this.#e=t,this.#o=null;const o=t=>"error"===t||this.#o?"error":t;this.#s=new y("creating",{creating:o,created:o,destroying:o,destroyed:()=>"destroyed",error:()=>"error"}),this.#e.registerEntity(this),0===this.#e.systems.compNamesBySystemName.size&&this.#s.next("created")}onCreate(t){}onDestroy(t){}onComponentAdd(t){}onTrackedComponentUpdate(t){}onComponentRemove(t){}add(t){if(!t)throw Error("Entity.add: Component is null or undefined");return this.#e.add(this.#t,t),this}addTag(t){let e=this.#e.entitiesByTags.has(t)?this.#e.entitiesByTags.get(t):new Set;return e&&(e.add(this.#t),this.#e.entitiesByTags.set(t,e)),this}has(t){return(this.#e.componentCollections.get(this.#t)||new f).has(t)}hasSome(t){return(this.#e.componentCollections.get(this.#t)||new f).has(t)}hasTag(t){if(this.#e.entitiesByTags.has(t)){let e=this.#e.entitiesByTags.get(t);if(e)return e.has(this.#t)}return!1}get(t){return(this.#e.componentCollections.get(this.#t)||new f).get(t)}getAll(){return this.#e.componentCollections.get(this.#t)||new f}remove(t){return this.#e.remove(this.#t,t),this}removeTag(t){if(this.#e.entitiesByTags.has(t)){let e=this.#e.entitiesByTags.get(t);e&&(e.delete(this.#t),0===e.size&&this.#e.entitiesByTags.delete(t))}return this}clear(){return this.#e.clearEntityComponents(this.#t),this}clearTags(){for(let[t,e]of this.#e.entitiesByTags.entries())e.delete(this.#t),0===e.size&&this.#e.entitiesByTags.delete(t);return this}finishCreation(){this.#s.next("created")}destroy(){0===this.#e.systems.compNamesBySystemName.size?this.destroyImmediately():this.#s.next("destroying")}destroyImmediately(){this.onDestroy(this.#e),this.#e.destroyEntity(this.#t),this.#s.next("destroyed")}get components(){return this.#e.componentCollections.get(this.#t)||new f}get tags(){let t=new Set;for(let[e,o]of this.#e.entitiesByTags.entries())o.has(this.#t)&&t.add(e);return t}toDevEntity(){return new h(this,this.#e)}}let g=class{world;constructor(t){this.world=t}get systemComponents(){let t=[];for(let[e,o]of this.world.systems.compNamesBySystemName)t.push({system:e,components:o.join(", ")});return t}get entities(){return[...this.world.entities.values()].map(t=>t.toDevEntity())}},v="__DEFAULT__";class S{world;compNamesBySystemName;phases=new Map;phaseOrder=["Input","Logic","Events","Render","Cleanup"];constructor(t){this.world=t,this.compNamesBySystemName=new Map,this.phases.set(v,[])}setPhaseOrder(t){this.phaseOrder=t}add(t,e,o,s={}){let n=t.map(t=>t.name),{phase:r=v,name:i}=s,a=i||e.name||o;return this.phases.has(r)||this.phases.set(r,[]),this.phases.get(r)?.push({func:e,name:a,key:o}),this.compNamesBySystemName.set(a,n),this.world.entitiesByCTypes.has(o)||this.world.entitiesByCTypes.set(o,new Set),this}run(t){let e=t?.dt??16.666,o=t?.time??performance.now(),s=(this.phases.get(v)||[]).length>0,n=Array.from(this.phases.keys()).some(t=>t!==v&&(this.phases.get(t)?.length??0)>0);if(s&&n)throw Error("Ambiguous system execution order: Some systems are registered with a phase, while others are not. Please assign a phase to all systems if you intend to use execution phases.");let r=[],i=[];for(let t of this.world.entities.values())"creating"===t.state?r.push(t):"destroying"===t.state&&i.push(t);let a=n?this.phaseOrder:[v];for(let t of this.phases.keys())t===v||a.includes(t)||a.push(t);for(let t of a){for(let{func:s,key:n}of this.phases.get(t)||[]){let t=this.world.entitiesByCTypes.get(n)||new Set,r=t.size;if(0===r)continue;let i=0;for(let n of t){let t=this.world.entities.get(n);t&&"destroyed"!==t.state&&(s({entity:t,components:this.world.componentCollections.get(n)||new f,world:this.world,index:i,size:r,isFirst:0===i,isLast:i+1===r,dt:e,time:o}),i++)}}this.world.events.processQueueForPhase(t)}for(let t of r)t.finishCreation();for(let t of i)t.destroyImmediately()}}let T={isTracked:Symbol.for("ecs.trackedComponent.isTracked"),world:Symbol.for("ecs.trackedComponent.world"),entityIDs:Symbol.for("ecs.trackedComponent.entityIDs"),getEntities:Symbol.for("ecs.trackedComponent.getEntities"),setWorld:Symbol.for("ecs.trackedComponent.setWorld"),onAdd:Symbol.for("ecs.trackedComponent.onAdd"),onUpdate:Symbol.for("ecs.trackedComponent.onUpdate"),onRemove:Symbol.for("ecs.trackedComponent.onRemove")};function w(t,e){return new Proxy(t,{construct(t,o){let s,n=new t(...o);return n[T.isTracked]=!0,n[T.setWorld]=t=>{n[T.world]=t},n[T.entityIDs]=new Set,n[T.getEntities]=t=>{let e=new Map;for(let o of n[T.entityIDs]){let s=t.entities.get(o);s&&e.set(o,s)}return e},n[T.onAdd]=(t,o)=>{if(e.onAdd){let s=n[T.getEntities](t);e.onAdd({component:n,world:t,entity:o,entities:s})}},n[T.onRemove]=(t,o)=>{if(e.onRemove){let s=n[T.getEntities](t);e.onRemove({component:n,world:t,entity:o,entities:s})}},new Proxy(n,(s=new Set,{set(t,o,n){s.add(o);let r=t[T.world],i=t[o];t[o]=n;let a=t[T.getEntities](r);for(let e of a.values())e.onTrackedComponentUpdate({world:r,component:t});return e.onUpdate&&e.onUpdate({entities:a,world:r,component:t,previousVal:i,property:o}),!0}}))}})}class C{world;listeners=new Map;queue=[];constructor(t){this.world=t}addListener(t,e,o){this.listeners.has(t)||this.listeners.set(t,[]);let s=this.listeners.get(t);s&&s.push({func:e,phase:o})}emit(t){this.queue.push(t)}processQueueForPhase(t){for(let e of[...this.queue]){let o=e.constructor;for(let s of this.listeners.get(o)||[])s.phase===t&&s.func({event:e,world:this.world})}}clearQueue(){this.queue=[]}}class A{componentCollections=new Map;entities=new Map;entitiesByCTypes=new Map;entitiesByTags=new Map;systems;dev;events;#n=0;componentToSystemQueries=new Map;resources=new Map;prefabs=new Map;constructor(){this.dev=new g(this),this.systems=new S(this),this.events=new C(this)}addSystemListener(t,e,o={}){let{phase:s="Events"}=o;return this.events.addListener(t,e,s),this}setResource(t){return this.resources.set(t.constructor,t),this}getResource(t){return this.resources.get(t)}hasResource(t){return this.resources.has(t)}removeResource(t){return this.resources.delete(t)}registerPrefab(t,e){return this.prefabs.set(t,e),this}createEntityFromPrefab(t,e={}){let o=this.prefabs.get(t);if(!o)throw Error(`Prefab with name "${t}" not found.`);let s=this.createEntity();if(o.tags)for(let t of o.tags)s.addTag(t);for(let t of o.components){let o=JSON.parse(JSON.stringify(t));Object.setPrototypeOf(o,t.constructor.prototype);let n=t.constructor.name;e[n]&&Object.assign(o,e[n]),s.add(o)}return s}setPhaseOrder(t){return this.systems.setPhaseOrder(t),this}find=t=>{for(let e of this.entities.values())if(t(e))return e;return null};findAll=t=>{let e=[];for(let o of this.entities.values())t(o)&&e.push(o);return e};locate=t=>{for(let e of this.entities.values())if(e.components.has(t))return e;return null};locateAll=t=>{let e=[];for(let o of this.entities.values())o.components.has(t)&&e.push(o);return e};grab=t=>{let e=this.locate(t);if(e){let o=(this.componentCollections.get(e.id)||new f).get(t);return{entity:e,component:o}}return null};grabBy=(t,e)=>{for(let o of this.locateAll(t)){let s=(this.componentCollections.get(o.id)||new f).get(t);if(e(s))return{component:s,entity:o}}return null};grabAll=t=>this.locateAll(t).map(e=>({entity:e,component:e.components.get(t)}));get=(t,e)=>(this.componentCollections.get(t)||new f).get(e);getComponent=(t,e)=>{let o=this.grab(t);return o?o.component:e||null};getTagged=t=>{let e=this.entitiesByTags.get(t);if(e){let t=e.values().next().value;if(void 0!==t){let e=this.entities.get(t);if(e)return e}}return null};getAllTagged=t=>{let e=[],o=this.entitiesByTags.get(t);if(o)for(let t of o){let o=this.entities.get(t);o&&e.push(o)}return e};add=(t,e)=>{let o=this.componentCollections.get(t)||new f,s=this.entities.get(t);if(!s)throw Error(`world.add: Unable to locate entity with id ${t}`);for(let[s,n]of(o.add(e),this.componentCollections.set(t,o),this.entitiesByCTypes))s.split(",").every(t=>o.hasByName(t))&&n.add(t);return e[T.isTracked]&&(e[T.setWorld](this),e[T.entityIDs].add(t),e[T.onAdd](this,s)),e.onAdd&&e.onAdd({world:this,entity:s,component:e}),s.onComponentAdd({world:this,component:e}),this};remove=(t,e)=>{let o=this.componentCollections.get(t);if(!o)return this;let s=e.name;if(!o.hasByName(s))return this;let n=o.get(e),r=this.entities.get(t);if(!r)return this;for(let e of(n.onRemove&&n.onRemove({world:this,entity:r,component:n}),n[T.isTracked]&&(n[T.entityIDs].delete(t),n[T.onRemove](this,r)),this.componentToSystemQueries.get(s)||[])){let o=this.entitiesByCTypes.get(e);o&&o.delete(t)}for(let[s,n]of(o.remove(e),this.entitiesByCTypes.entries()))s.split(",").every(t=>o.hasByName(t))&&n.add(t);return r.onComponentRemove({world:this,component:n}),this};addSystem(t,e,o={}){let s=t.map(t=>t.name).sort(),n=s.join(",");for(let t of s){let e=this.componentToSystemQueries.get(t)||[];e.includes(n)||e.push(n),this.componentToSystemQueries.set(t,e)}return this.systems.add(t,e,n,o),this}registerEntity(t){let e=new f;return this.componentCollections.set(t.id,e),this.entities.set(t.id,t),t.onCreate(this),this}clearEntityComponents(t){for(let e of(this.componentCollections.set(t,new f),this.entitiesByCTypes.values()))e.has(t)&&e.delete(t);return this}createEntity(){return new m(this,++this.#n)}destroyEntity(t){if(this.componentCollections.delete(t),!this.entities.get(t))throw Error(`world.destroyEntity: No entity found. entity id: ${t}`);for(let e of(this.entities.delete(t),this.entitiesByCTypes.values()))e.has(t)&&e.delete(t);for(let[e,o]of this.entitiesByTags)o.has(t)&&o.delete(t),0===o.size&&this.entitiesByTags.delete(e);return this}toJSON(){let t={resources:[],entities:[]};for(let[e,o]of this.resources.entries()){let s=o.toJSON?o.toJSON():c(o);t.resources.push({name:e.name,data:s})}for(let e of this.entities.values()){let o=[],s=this.componentCollections.get(e.id);if(s)for(let t of s){let e=t.toJSON?t.toJSON():c(t);o.push({name:t.constructor.name,data:e})}t.entities.push({id:e.id,tags:Array.from(e.tags),components:o})}return t}static fromJSON(t,e){let o=new A;for(let s of t.resources){let t=e.resources[s.name];if(!t)throw Error(`Cannot hydrate resource: Class constructor for "${s.name}" not found in typeMapping.resources.`);let n=t.fromJSON?t.fromJSON(s.data):d(t,s.data);o.setResource(n)}for(let s of t.entities){let t=o.createEntity();for(let e of s.tags)t.addTag(e);for(let o of s.components){let s=e.components[o.name];if(!s)throw Error(`Cannot hydrate component: Class constructor for "${o.name}" not found in typeMapping.components.`);let n=s.fromJSON?s.fromJSON(o.data):d(s,o.data);t.add(n)}}return o}}module.exports=s})();