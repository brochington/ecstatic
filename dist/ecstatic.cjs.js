(()=>{"use strict";var e={};e.d=(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},e.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var t={};function s(e,t){return!!t&&t instanceof e}e.r(t),e.d(t,{ComponentRegistry:()=>f,Entity:()=>a,trackComponent:()=>c,World:()=>y,Query:()=>p,BitSet:()=>r});class n{components=new Map;add=e=>{this.components.set(e.constructor.name,e)};update=(e,t)=>{let n=this.components.get(e.name);if(s(e,n)){let s=t(n);this.components.set(e.name,s)}};remove=e=>{this.components.delete(e.name)};get=e=>{let t=this.components.get(e.name);if(s(e,t))return t;throw Error(`ComponentCollection does not have component of type ${e.name}`)};has=e=>Array.isArray(e)?e.every(e=>!0===this.components.has(e.name)):this.components.has(e.name);hasSome=e=>e.some(e=>!0===this.components.has(e.name));hasByName=e=>Array.isArray(e)?e.every(e=>!0===this.components.has(e)):this.components.has(e);get componentTypes(){return[...this.components.keys()]}get size(){return this.components.size}[Symbol.iterator](){return this.components.values()}toDevComponents(){let e={};for(let[t,s]of this.components)e[t]=s;return e}}let i=class{id;components;tags;systems=[];state;constructor(e,t){this.id=e.id,this.components=e.components.toDevComponents(),this.tags=[...e.tags],this.state=e.state;const s=Object.keys(this.components);for(const[e,n]of t.systems.compNamesBySystemName)n.every(e=>s.includes(e))&&this.systems.push(e)}toTableRow(){return{id:this.id,components:Object.keys(this.components).join(", "),tags:this.tags.join(", "),systems:this.systems.join(", ")}}};class o{current;inital;transitions;constructor(e,t){this.inital=e,this.current=e,this.transitions=t}next(e){this.transitions[this.current]&&(this.current=this.transitions[this.current](e,this.current))}reset(){this.current=this.inital}is(e){return this.current===e}}class r{mask;size;constructor(e=1){this.size=e,this.mask=new Uint32Array(e)}set(e){let t=Math.floor(e/32);t>=this.mask.length&&this.resize(t+1),this.mask[t]|=1<<e%32}clear(e){let t=Math.floor(e/32);t<this.mask.length&&(this.mask[t]&=~(1<<e%32))}resize(e){let t=new Uint32Array(e);t.set(this.mask),this.mask=t,this.size=e}contains(e){let t=e.mask.length;for(let s=0;s<t;s++){let t=e.mask[s];if((this.mask[s]&t)!==t)return!1}return!0}intersects(e){let t=Math.min(this.mask.length,e.mask.length);for(let s=0;s<t;s++)if((this.mask[s]&e.mask[s])!=0)return!0;return!1}equals(e){let t=Math.max(this.mask.length,e.mask.length);for(let s=0;s<t;s++)if((this.mask[s]||0)!==(e.mask[s]||0))return!1;return!0}count(){let e=0,t=this.mask.length;for(let s=0;s<t;s++){let t=this.mask[s];t-=t>>>1&0x55555555,e+=((t=(0x33333333&t)+(t>>>2&0x33333333))+(t>>>4)&0xf0f0f0f)*0x1010101>>>24}return e}toString(){return this.mask.join("-")}clone(){let e=new r(this.size);return e.mask.set(this.mask),e}}class a{_id;_world;_componentMask;_error;_state;get id(){return this._id}get world(){return this._world}get componentMask(){return this._componentMask}get state(){return this._state.current}constructor(e,t){this._id=t,this._world=e,this._componentMask=new r,this._error=null;const s=e=>"error"===e||this._error?"error":e;this._state=new o("creating",{creating:s,created:s,destroying:s,destroyed:()=>"destroyed",error:()=>"error"}),this._world.registerEntity(this),0===this._world.systems.compNamesBySystemName.size&&this._state.next("created")}onCreate(e){}onDestroy(e){}onComponentAdd(e){}onTrackedComponentUpdate(e){}onComponentRemove(e){}add(e){if(!e)throw Error("Entity.add: Component is null or undefined");return this._world.add(this._id,e),this}addTag(e){let t=this._world.entitiesByTags.has(e)?this._world.entitiesByTags.get(e):new Set;return t&&(t.add(this._id),this._world.entitiesByTags.set(e,t)),this}has(e){return(this._world.componentCollections[this._id]||new n).has(e)}hasSome(e){return(this._world.componentCollections[this._id]||new n).hasSome(e)}hasTag(e){if(this._world.entitiesByTags.has(e)){let t=this._world.entitiesByTags.get(e);if(t)return t.has(this._id)}return!1}get(e){return(this._world.componentCollections[this._id]||new n).get(e)}getAll(){return this._world.componentCollections[this._id]||new n}remove(e){return this._world.remove(this._id,e),this}removeTag(e){if(this._world.entitiesByTags.has(e)){let t=this._world.entitiesByTags.get(e);t&&(t.delete(this._id),0===t.size&&this._world.entitiesByTags.delete(e))}return this}clear(){return this._world.clearEntityComponents(this._id),this._componentMask=new r,this}clearTags(){for(let[e,t]of this._world.entitiesByTags.entries())t.delete(this._id),0===t.size&&this._world.entitiesByTags.delete(e);return this}finishCreation(){this._state.next("created")}destroy(){0===this._world.systems.compNamesBySystemName.size?this.destroyImmediately():(this._state.next("destroying"),this._world.entitiesToDestroy.add(this))}destroyImmediately(){this.onDestroy(this._world),this._world.destroyEntity(this._id),this._state.next("destroyed")}get components(){return this._world.componentCollections[this._id]||new n}get tags(){let e=new Set;for(let[t,s]of this._world.entitiesByTags.entries())s.has(this._id)&&e.add(t);return e}toDevEntity(){return new i(this,this._world)}}let l=class{world;constructor(e){this.world=e}get systemComponents(){let e=[];for(let[t,s]of this.world.systems.compNamesBySystemName)e.push({system:t,components:s.join(", ")});return e}get entities(){return this.world.entities.filter(e=>void 0!==e).map(e=>e.toDevEntity())}},h="__DEFAULT__";class d{world;compNamesBySystemName;phases=new Map;phaseOrder=["Input","Logic","Events","Render","Cleanup"];constructor(e){this.world=e,this.compNamesBySystemName=new Map,this.phases.set(h,[])}setPhaseOrder(e){this.phaseOrder=e}add(e,t,s={}){let{phase:n=h,name:i}=s,o=i||t.name||e.key;this.phases.has(n)||this.phases.set(n,[]),this.phases.get(n)?.push({func:t,name:o,query:e});let r=Array.from(e.relevantComponents);return this.compNamesBySystemName.set(o,r),this.validatePhases(),this}validatePhases(){let e=(this.phases.get(h)||[]).length>0,t=Array.from(this.phases.keys()).some(e=>e!==h&&(this.phases.get(e)?.length??0)>0);if(e&&t)throw Error("Ambiguous system execution order: Some systems are registered with a phase, while others are not. Please assign a phase to all systems if you intend to use execution phases.")}run(e){let t=e?.dt??16.666,s=e?.time??performance.now(),n={entity:null,components:null,world:this.world,index:0,size:0,isFirst:!1,isLast:!1,dt:t,time:s},i=[],o=this.phases.get(h);if(o&&o.length>0)i.push(h);else{for(let e of this.phaseOrder)i.push(e);for(let e of this.phases.keys())e===h||this.phaseOrder.includes(e)||i.push(e)}for(let e of i){let t=this.phases.get(e);if(t&&t.length>0)for(let e of t){let t=e.query.entities,s=t.size;if(0===s)continue;let i=0;for(let o of(n.size=s,t)){let t=this.world.entities[o];if(!t||"created"!==t.state&&"creating"!==t.state&&"destroying"!==t.state)continue;let r=this.world.componentCollections[o];r&&(n.entity=t,n.components=r,n.index=i,n.isFirst=0===i,n.isLast=i+1===s,e.func(n),i++)}}this.world.events.processQueueForPhase(e)}if(this.world.entitiesToCreate.size>0){for(let e of this.world.entitiesToCreate)e.finishCreation();this.world.entitiesToCreate.clear()}if(this.world.entitiesToDestroy.size>0){for(let e of this.world.entitiesToDestroy)e.destroyImmediately();this.world.entitiesToDestroy.clear()}this.world.events.clearQueue()}}let m={isTracked:Symbol.for("ecs.trackedComponent.isTracked"),world:Symbol.for("ecs.trackedComponent.world"),entityIDs:Symbol.for("ecs.trackedComponent.entityIDs"),getEntities:Symbol.for("ecs.trackedComponent.getEntities"),setWorld:Symbol.for("ecs.trackedComponent.setWorld"),onAdd:Symbol.for("ecs.trackedComponent.onAdd"),onUpdate:Symbol.for("ecs.trackedComponent.onUpdate"),onRemove:Symbol.for("ecs.trackedComponent.onRemove")};function c(e,t){return new Proxy(e,{construct(e,s){let n,i=new e(...s);return i[m.isTracked]=!0,i[m.setWorld]=e=>{i[m.world]=e},i[m.entityIDs]=new Set,i[m.getEntities]=e=>{let t=new Map;for(let s of i[m.entityIDs]){let n=e.entities[s];n&&t.set(s,n)}return t},i[m.onAdd]=(e,s)=>{if(t.onAdd){let n=i[m.getEntities](e);t.onAdd({component:i,world:e,entity:s,entities:n})}},i[m.onRemove]=(e,s)=>{if(t.onRemove){let n=i[m.getEntities](e);t.onRemove({component:i,world:e,entity:s,entities:n})}},new Proxy(i,(n=new Set,{set(e,s,i){n.add(s);let o=e[m.world],r=e[s];e[s]=i;let a=e[m.getEntities](o);for(let t of a.values())t.onTrackedComponentUpdate({world:o,component:e});return t.onUpdate&&t.onUpdate({entities:a,world:o,component:e,previousVal:r,property:s}),!0}}))}})}class u{world;listeners=new Map;queue=[];constructor(e){this.world=e}addListener(e,t,s){this.listeners.has(e)||this.listeners.set(e,[]);let n=this.listeners.get(e);n&&n.push({func:t,phase:s})}emit(e){this.queue.push(e)}processQueueForPhase(e){for(let t of[...this.queue]){let s=t.constructor;for(let n of this.listeners.get(s)||[])n.phase===e&&n.func({event:t,world:this.world})}}clearQueue(){this.queue=[]}}class f{static nextId=0;static registry=new Map;static getId(e){return this.registry.has(e)||this.registry.set(e,this.nextId++),this.registry.get(e)}}class p{world;entities=new Set;key;allMask=null;anyMask=null;noneMask=null;onlyMask=null;differentMask=null;minCount=0;maxCount=1/0;isUniversal;relevantComponents=new Set;constructor(e,t){this.world=e;const s=[];if(t.all&&t.all.length>0){const e=[...t.all].sort((e,t)=>e.name.localeCompare(t.name));this.allMask=new r,e.forEach(e=>{this.allMask?.set(f.getId(e)),this.relevantComponents.add(e.name)}),s.push(`all:${e.map(e=>e.name).join(",")}`)}if(t.any&&t.any.length>0){const e=[...t.any].sort((e,t)=>e.name.localeCompare(t.name));this.anyMask=new r,e.forEach(e=>{this.anyMask?.set(f.getId(e)),this.relevantComponents.add(e.name)}),s.push(`any:${e.map(e=>e.name).join(",")}`)}if(t.none&&t.none.length>0){const e=[...t.none].sort((e,t)=>e.name.localeCompare(t.name));this.noneMask=new r,e.forEach(e=>{this.noneMask?.set(f.getId(e)),this.relevantComponents.add(e.name)}),s.push(`none:${e.map(e=>e.name).join(",")}`)}const n=t.only||t.same;if(n&&n.length>0){const e=[...n].sort((e,t)=>e.name.localeCompare(t.name));this.onlyMask=new r,e.forEach(e=>this.onlyMask?.set(f.getId(e))),s.push(`only:${e.map(e=>e.name).join(",")}`)}if(t.different&&t.different.length>0){const e=[...t.different].sort((e,t)=>e.name.localeCompare(t.name));this.differentMask=new r,e.forEach(e=>this.differentMask?.set(f.getId(e))),s.push(`diff:${e.map(e=>e.name).join(",")}`)}void 0!==t.min&&(this.minCount=t.min,s.push(`min:${t.min}`)),void 0!==t.max&&(this.maxCount=t.max,s.push(`max:${t.max}`)),this.key=s.join("|"),this.isUniversal=!!this.onlyMask||!!this.differentMask||this.minCount>0||this.maxCount<1/0}match(e){let t=e.componentMask;if(this.allMask&&!t.contains(this.allMask)||this.noneMask&&t.intersects(this.noneMask)||this.anyMask&&!t.intersects(this.anyMask)||this.onlyMask&&!t.equals(this.onlyMask)||this.differentMask&&t.equals(this.differentMask))return!1;if(this.minCount>0||this.maxCount<1/0){let e=t.count();if(e<this.minCount||e>this.maxCount)return!1}return!0}*[Symbol.iterator](){for(let e of this.entities){let t=this.world.entities[e];t&&(yield t)}}get(){return Array.from(this)}first(){let e=this.entities.values().next().value;return void 0!==e&&this.world.entities[e]||null}get size(){return this.entities.size}}class y{componentCollections=[];entities=[];queries=new Map;entitiesByTags=new Map;entitiesToCreate=new Set;entitiesToDestroy=new Set;systems;dev;events;nextEntityId=0;componentToQueries=new Map;universalQueries=new Set;resources=new Map;prefabs=new Map;constructor(){this.dev=new l(this),this.systems=new d(this),this.events=new u(this)}query(e){let t=new p(this,e),s=t.key;if(this.queries.has(s))return this.queries.get(s);for(let e of(this.queries.set(s,t),this.entities))e&&"destroyed"!==e.state&&t.match(e)&&t.entities.add(e.id);if(t.isUniversal)this.universalQueries.add(s);else for(let e of t.relevantComponents)this.componentToQueries.has(e)||this.componentToQueries.set(e,new Set),this.componentToQueries.get(e)?.add(s);return t}addSystemListener(e,t,s={}){let{phase:n="Events"}=s;return this.events.addListener(e,t,n),this}setResource(e){return this.resources.set(e.constructor,e),this}getResource(e){return this.resources.get(e)}hasResource(e){return this.resources.has(e)}removeResource(e){return this.resources.delete(e)}registerPrefab(e,t){return this.prefabs.set(e,t),this}createEntityFromPrefab(e,t={}){let s=this.prefabs.get(e);if(!s)throw Error(`Prefab with name "${e}" not found.`);let n=this.createEntity();if(s.tags)for(let e of s.tags)n.addTag(e);for(let e of s.components){let s=JSON.parse(JSON.stringify(e));Object.setPrototypeOf(s,e.constructor.prototype);let i=e.constructor.name;t[i]&&Object.assign(s,t[i]),n.add(s)}return n}setPhaseOrder(e){return this.systems.setPhaseOrder(e),this}find=e=>{for(let t of this.entities)if(t&&e(t))return t;return null};findAll=e=>{let t=[];for(let s of this.entities)s&&e(s)&&t.push(s);return t};locate=e=>{let t=(Array.isArray(e)?e:[e]).map(e=>e.name).sort().join(","),s=`all:${t}`;if(this.queries.has(s))return this.queries.get(s).first();for(let t of this.entities)if(t&&t.components.has(e))return t;return null};locateAll=e=>{let t=(Array.isArray(e)?e:[e]).map(e=>e.name).sort().join(","),s=`all:${t}`;if(this.queries.has(s))return this.queries.get(s)?.get()||[];let n=[];for(let t of this.entities)t&&t.components.has(e)&&n.push(t);return n};grab=e=>{let t=this.locate(e);if(t){let s=(this.componentCollections[t.id]||new n).get(e);return{entity:t,component:s}}return null};grabBy=(e,t)=>{for(let s of this.locateAll(e)){let i=(this.componentCollections[s.id]||new n).get(e);if(t(i))return{component:i,entity:s}}return null};grabAll=e=>this.locateAll(e).map(t=>({entity:t,component:t.components.get(e)}));get=(e,t)=>(this.componentCollections[e]||new n).get(t);getComponent=(e,t)=>{let s=this.grab(e);return s?s.component:t||null};getTagged=e=>{let t=this.entitiesByTags.get(e);if(t){let e=t.values().next().value;if(void 0!==e){let t=this.entities[e];if(t)return t}}return null};getAllTagged=e=>{let t=[],s=this.entitiesByTags.get(e);if(s)for(let e of s){let s=this.entities[e];s&&t.push(s)}return t};add=(e,t)=>{let s=this.componentCollections[e];s||(s=new n,this.componentCollections[e]=s);let i=this.entities[e];if(!i)throw Error(`world.add: Unable to locate entity with id ${e}`);let o=f.getId(t.constructor);return i.componentMask.set(o),s.add(t),this.updateQueries(i,t.constructor.name),t[m.isTracked]&&(t[m.setWorld](this),t[m.entityIDs].add(e),t[m.onAdd](this,i)),t.onAdd&&t.onAdd({world:this,entity:i,component:t}),i.onComponentAdd({world:this,component:t}),this};remove=(e,t)=>{let s=this.componentCollections[e];if(!s)return this;let n=t.name;if(!s.hasByName(n))return this;let i=s.get(t),o=this.entities[e];if(!o)return this;i.onRemove&&i.onRemove({world:this,entity:o,component:i}),i[m.isTracked]&&(i[m.entityIDs].delete(e),i[m.onRemove](this,o));let r=f.getId(t);return o.componentMask.clear(r),s.remove(t),this.updateQueries(o,n),o.onComponentRemove({world:this,component:i}),this};updateQueries(e,t){let s=this.componentToQueries.get(t);if(s)for(let t of s)this.checkQuery(t,e);for(let t of this.universalQueries)this.checkQuery(t,e)}checkQuery(e,t){let s=this.queries.get(e);if(!s)return;let n=s.match(t),i=s.entities.has(t.id);n&&!i?s.entities.add(t.id):!n&&i&&s.entities.delete(t.id)}addSystem(e,t,s={}){let n;return e instanceof p?(n=e,this.queries.has(n.key)||this.queries.set(n.key,n)):n=Array.isArray(e)?this.query({all:e}):this.query(e),this.systems.add(n,t,s),this}registerEntity(e){let t=new n;return this.componentCollections[e.id]=t,this.entities[e.id]=e,this.entitiesToCreate.add(e),e.onCreate(this),this}clearEntityComponents(e){for(let t of(this.componentCollections[e]=new n,this.queries.values()))t.entities.has(e)&&t.entities.delete(e);return this}createEntity(){return new a(this,++this.nextEntityId)}destroyEntity(e){delete this.componentCollections[e];let t=this.entities[e];if(!t)throw Error(`world.destroyEntity: No entity found. entity id: ${e}`);for(let s of(delete this.entities[e],this.entitiesToCreate.delete(t),this.entitiesToDestroy.delete(t),this.queries.values()))s.entities.has(e)&&s.entities.delete(e);for(let[t,s]of this.entitiesByTags)s.has(e)&&s.delete(e),0===s.size&&this.entitiesByTags.delete(t);return this}toJSON(){let e={resources:[],entities:[]};for(let[t,s]of this.resources.entries()){let n=s.toJSON?s.toJSON():{...s};e.resources.push({name:t.name,data:n})}for(let t of this.entities){if(!t)continue;let s=[],n=this.componentCollections[t.id];if(n)for(let e of n){let t=e.toJSON?e.toJSON():{...e};s.push({name:e.constructor.name,data:t})}e.entities.push({id:t.id,tags:Array.from(t.tags),components:s})}return e}static fromJSON(e,t){let s=new y;for(let n of e.resources){let e,i=t.resources[n.name];if(!i)throw Error(`Cannot hydrate resource: Class constructor for "${n.name}" not found in typeMapping.resources.`);i.fromJSON?e=i.fromJSON(n.data):Object.assign(e=new i,n.data),s.setResource(e)}let n=0;for(let t of e.entities)"number"==typeof t.id&&t.id>n&&(n=t.id);for(let i of(s.nextEntityId=n,e.entities)){let e=new a(s,i.id);for(let t of(s.registerEntity(e),i.tags))e.addTag(t);for(let s of i.components){let n,i=t.components[s.name];if(!i)throw Error(`Cannot hydrate component: Class constructor for "${s.name}" not found in typeMapping.components.`);i.fromJSON?n=i.fromJSON(s.data):Object.assign(n=new i,s.data),e.add(n)}}return s}}module.exports=t})();