(()=>{"use strict";var t={};t.d=(e,s)=>{for(var o in s)t.o(s,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:s[o]})},t.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var e={};function s(t,e){return!!e&&e instanceof t}t.r(e),t.d(e,{ComponentRegistry:()=>p,Entity:()=>a,World:()=>y,trackComponent:()=>m,BitSet:()=>r});class o{components=new Map;add=t=>{this.components.set(t.constructor.name,t)};update=(t,e)=>{let o=this.components.get(t.name);if(s(t,o)){let s=e(o);this.components.set(t.name,s)}};remove=t=>{this.components.delete(t.name)};get=t=>{let e=this.components.get(t.name);if(s(t,e))return e;throw Error(`ComponentCollection does not have component of type ${t.name}`)};has=t=>Array.isArray(t)?t.every(t=>!0===this.components.has(t.name)):this.components.has(t.name);hasSome=t=>t.some(t=>!0===this.components.has(t.name));hasByName=t=>Array.isArray(t)?t.every(t=>!0===this.components.has(t)):this.components.has(t);get componentTypes(){return[...this.components.keys()]}get size(){return this.components.size}[Symbol.iterator](){return this.components.values()}toDevComponents(){let t={};for(let[e,s]of this.components)t[e]=s;return t}}let i=class{id;components;tags;systems=[];state;constructor(t,e){this.id=t.id,this.components=t.components.toDevComponents(),this.tags=[...t.tags],this.state=t.state;const s=Object.keys(this.components);for(const[t,o]of e.systems.compNamesBySystemName)o.every(t=>s.includes(t))&&this.systems.push(t)}toTableRow(){return{id:this.id,components:Object.keys(this.components).join(", "),tags:this.tags.join(", "),systems:this.systems.join(", ")}}};class n{current;inital;transitions;constructor(t,e){this.inital=t,this.current=t,this.transitions=e}next(t){this.transitions[this.current]&&(this.current=this.transitions[this.current](t,this.current))}reset(){this.current=this.inital}is(t){return this.current===t}}class r{mask;size;constructor(t=1){this.size=t,this.mask=new Uint32Array(t)}set(t){let e=Math.floor(t/32);e>=this.mask.length&&this.resize(e+1),this.mask[e]|=1<<t%32}clear(t){let e=Math.floor(t/32);e<this.mask.length&&(this.mask[e]&=~(1<<t%32))}resize(t){let e=new Uint32Array(t);e.set(this.mask),this.mask=e,this.size=t}contains(t){let e=t.mask.length;for(let s=0;s<e;s++){let e=t.mask[s];if((this.mask[s]&e)!==e)return!1}return!0}toString(){return this.mask.join("-")}clone(){let t=new r(this.size);return t.mask.set(this.mask),t}}class a{_id;_world;_componentMask;_error;_state;get id(){return this._id}get world(){return this._world}get componentMask(){return this._componentMask}get state(){return this._state.current}constructor(t,e){this._id=e,this._world=t,this._componentMask=new r,this._error=null;const s=t=>"error"===t||this._error?"error":t;this._state=new n("creating",{creating:s,created:s,destroying:s,destroyed:()=>"destroyed",error:()=>"error"}),this._world.registerEntity(this),0===this._world.systems.compNamesBySystemName.size&&this._state.next("created")}onCreate(t){}onDestroy(t){}onComponentAdd(t){}onTrackedComponentUpdate(t){}onComponentRemove(t){}add(t){if(!t)throw Error("Entity.add: Component is null or undefined");return this._world.add(this._id,t),this}addTag(t){let e=this._world.entitiesByTags.has(t)?this._world.entitiesByTags.get(t):new Set;return e&&(e.add(this._id),this._world.entitiesByTags.set(t,e)),this}has(t){return(this._world.componentCollections[this._id]||new o).has(t)}hasSome(t){return(this._world.componentCollections[this._id]||new o).has(t)}hasTag(t){if(this._world.entitiesByTags.has(t)){let e=this._world.entitiesByTags.get(t);if(e)return e.has(this._id)}return!1}get(t){return(this._world.componentCollections[this._id]||new o).get(t)}getAll(){return this._world.componentCollections[this._id]||new o}remove(t){return this._world.remove(this._id,t),this}removeTag(t){if(this._world.entitiesByTags.has(t)){let e=this._world.entitiesByTags.get(t);e&&(e.delete(this._id),0===e.size&&this._world.entitiesByTags.delete(t))}return this}clear(){return this._world.clearEntityComponents(this._id),this._componentMask=new r,this}clearTags(){for(let[t,e]of this._world.entitiesByTags.entries())e.delete(this._id),0===e.size&&this._world.entitiesByTags.delete(t);return this}finishCreation(){this._state.next("created")}destroy(){0===this._world.systems.compNamesBySystemName.size?this.destroyImmediately():(this._state.next("destroying"),this._world.entitiesToDestroy.add(this))}destroyImmediately(){this.onDestroy(this._world),this._world.destroyEntity(this._id),this._state.next("destroyed")}get components(){return this._world.componentCollections[this._id]||new o}get tags(){let t=new Set;for(let[e,s]of this._world.entitiesByTags.entries())s.has(this._id)&&t.add(e);return t}toDevEntity(){return new i(this,this._world)}}let l=class{world;constructor(t){this.world=t}get systemComponents(){let t=[];for(let[e,s]of this.world.systems.compNamesBySystemName)t.push({system:e,components:s.join(", ")});return t}get entities(){return this.world.entities.filter(t=>void 0!==t).map(t=>t.toDevEntity())}},h="__DEFAULT__";class d{world;compNamesBySystemName;phases=new Map;phaseOrder=["Input","Logic","Events","Render","Cleanup"];constructor(t){this.world=t,this.compNamesBySystemName=new Map,this.phases.set(h,[])}setPhaseOrder(t){this.phaseOrder=t}add(t,e,s,o={}){let i=t.map(t=>t.name),{phase:n=h,name:r}=o,a=r||e.name||s;this.phases.has(n)||this.phases.set(n,[]);let l=this.world.systemQueries.get(s);if(!l)throw Error(`System Query not found for key: ${s}`);return this.phases.get(n)?.push({func:e,name:a,key:s,entities:l.entities}),this.compNamesBySystemName.set(a,i),this.validatePhases(),this}validatePhases(){let t=(this.phases.get(h)||[]).length>0,e=Array.from(this.phases.keys()).some(t=>t!==h&&(this.phases.get(t)?.length??0)>0);if(t&&e)throw Error("Ambiguous system execution order: Some systems are registered with a phase, while others are not. Please assign a phase to all systems if you intend to use execution phases.")}run(t){let e=t?.dt??16.666,s=t?.time??performance.now(),o={entity:null,components:null,world:this.world,index:0,size:0,isFirst:!1,isLast:!1,dt:e,time:s},i=[],n=this.phases.get(h);if(n&&n.length>0)i.push(h);else{for(let t of this.phaseOrder)i.push(t);for(let t of this.phases.keys())t===h||this.phaseOrder.includes(t)||i.push(t)}for(let t of i){let e=this.phases.get(t);if(e&&e.length>0)for(let t of e){let e=t.entities,s=e.size;if(0===s)continue;let i=0;for(let n of(o.size=s,e)){let e=this.world.entities[n];if(!e||"created"!==e.state&&"creating"!==e.state&&"destroying"!==e.state)continue;let r=this.world.componentCollections[n];r&&(o.entity=e,o.components=r,o.index=i,o.isFirst=0===i,o.isLast=i+1===s,t.func(o),i++)}}this.world.events.processQueueForPhase(t)}if(this.world.entitiesToCreate.size>0){for(let t of this.world.entitiesToCreate)t.finishCreation();this.world.entitiesToCreate.clear()}if(this.world.entitiesToDestroy.size>0){for(let t of this.world.entitiesToDestroy)t.destroyImmediately();this.world.entitiesToDestroy.clear()}}}let c={isTracked:Symbol.for("ecs.trackedComponent.isTracked"),world:Symbol.for("ecs.trackedComponent.world"),entityIDs:Symbol.for("ecs.trackedComponent.entityIDs"),getEntities:Symbol.for("ecs.trackedComponent.getEntities"),setWorld:Symbol.for("ecs.trackedComponent.setWorld"),onAdd:Symbol.for("ecs.trackedComponent.onAdd"),onUpdate:Symbol.for("ecs.trackedComponent.onUpdate"),onRemove:Symbol.for("ecs.trackedComponent.onRemove")};function m(t,e){return new Proxy(t,{construct(t,s){let o,i=new t(...s);return i[c.isTracked]=!0,i[c.setWorld]=t=>{i[c.world]=t},i[c.entityIDs]=new Set,i[c.getEntities]=t=>{let e=new Map;for(let s of i[c.entityIDs]){let o=t.entities[s];o&&e.set(s,o)}return e},i[c.onAdd]=(t,s)=>{if(e.onAdd){let o=i[c.getEntities](t);e.onAdd({component:i,world:t,entity:s,entities:o})}},i[c.onRemove]=(t,s)=>{if(e.onRemove){let o=i[c.getEntities](t);e.onRemove({component:i,world:t,entity:s,entities:o})}},new Proxy(i,(o=new Set,{set(t,s,i){o.add(s);let n=t[c.world],r=t[s];t[s]=i;let a=t[c.getEntities](n);for(let e of a.values())e.onTrackedComponentUpdate({world:n,component:t});return e.onUpdate&&e.onUpdate({entities:a,world:n,component:t,previousVal:r,property:s}),!0}}))}})}class u{world;listeners=new Map;queue=[];constructor(t){this.world=t}addListener(t,e,s){this.listeners.has(t)||this.listeners.set(t,[]);let o=this.listeners.get(t);o&&o.push({func:e,phase:s})}emit(t){this.queue.push(t)}processQueueForPhase(t){for(let e of[...this.queue]){let s=e.constructor;for(let o of this.listeners.get(s)||[])o.phase===t&&o.func({event:e,world:this.world})}}clearQueue(){this.queue=[]}}class p{static nextId=0;static registry=new Map;static getId(t){return this.registry.has(t)||this.registry.set(t,this.nextId++),this.registry.get(t)}}class y{componentCollections=[];entities=[];entitiesByQuery=new Map;systemQueries=new Map;entitiesByTags=new Map;entitiesToCreate=new Set;entitiesToDestroy=new Set;systems;dev;events;nextEntityId=0;componentToSystemQueries=new Map;resources=new Map;prefabs=new Map;constructor(){this.dev=new l(this),this.systems=new d(this),this.events=new u(this)}addSystemListener(t,e,s={}){let{phase:o="Events"}=s;return this.events.addListener(t,e,o),this}setResource(t){return this.resources.set(t.constructor,t),this}getResource(t){return this.resources.get(t)}hasResource(t){return this.resources.has(t)}removeResource(t){return this.resources.delete(t)}registerPrefab(t,e){return this.prefabs.set(t,e),this}createEntityFromPrefab(t,e={}){let s=this.prefabs.get(t);if(!s)throw Error(`Prefab with name "${t}" not found.`);let o=this.createEntity();if(s.tags)for(let t of s.tags)o.addTag(t);for(let t of s.components){let s=JSON.parse(JSON.stringify(t));Object.setPrototypeOf(s,t.constructor.prototype);let i=t.constructor.name;e[i]&&Object.assign(s,e[i]),o.add(s)}return o}setPhaseOrder(t){return this.systems.setPhaseOrder(t),this}find=t=>{for(let e of this.entities)if(e&&t(e))return e;return null};findAll=t=>{let e=[];for(let s of this.entities)s&&t(s)&&e.push(s);return e};locate=t=>{for(let e of this.entities)if(e&&e.components.has(t))return e;return null};locateAll=t=>{let e=[];for(let s of this.entities)s&&s.components.has(t)&&e.push(s);return e};grab=t=>{let e=this.locate(t);if(e){let s=(this.componentCollections[e.id]||new o).get(t);return{entity:e,component:s}}return null};grabBy=(t,e)=>{for(let s of this.locateAll(t)){let i=(this.componentCollections[s.id]||new o).get(t);if(e(i))return{component:i,entity:s}}return null};grabAll=t=>this.locateAll(t).map(e=>({entity:e,component:e.components.get(t)}));get=(t,e)=>(this.componentCollections[t]||new o).get(e);getComponent=(t,e)=>{let s=this.grab(t);return s?s.component:e||null};getTagged=t=>{let e=this.entitiesByTags.get(t);if(e){let t=e.values().next().value;if(void 0!==t){let e=this.entities[t];if(e)return e}}return null};getAllTagged=t=>{let e=[],s=this.entitiesByTags.get(t);if(s)for(let t of s){let s=this.entities[t];s&&e.push(s)}return e};add=(t,e)=>{let s=this.componentCollections[t];s||(s=new o,this.componentCollections[t]=s);let i=this.entities[t];if(!i)throw Error(`world.add: Unable to locate entity with id ${t}`);let n=p.getId(e.constructor);i.componentMask.set(n),s.add(e);let r=e.constructor.name;for(let e of this.componentToSystemQueries.get(r)||[]){let s=this.systemQueries.get(e);s&&i.componentMask.contains(s.mask)&&s.entities.add(t)}return e[c.isTracked]&&(e[c.setWorld](this),e[c.entityIDs].add(t),e[c.onAdd](this,i)),e.onAdd&&e.onAdd({world:this,entity:i,component:e}),i.onComponentAdd({world:this,component:e}),this};remove=(t,e)=>{let s=this.componentCollections[t];if(!s)return this;let o=e.name;if(!s.hasByName(o))return this;let i=s.get(e),n=this.entities[t];if(!n)return this;i.onRemove&&i.onRemove({world:this,entity:n,component:i}),i[c.isTracked]&&(i[c.entityIDs].delete(t),i[c.onRemove](this,n));let r=p.getId(e);for(let e of(n.componentMask.clear(r),this.componentToSystemQueries.get(o)||[])){let s=this.systemQueries.get(e);s&&s.entities.delete(t)}return s.remove(e),n.onComponentRemove({world:this,component:i}),this};addSystem(t,e,s={}){let o=t.map(t=>t.name).sort(),i=o.join(","),n=new r;for(let e of t){let t=p.getId(e);n.set(t)}if(!this.systemQueries.has(i)){let t=new Set;this.systemQueries.set(i,{mask:n,entities:t,key:i}),this.entitiesByQuery.set(i,t)}for(let t of o){let e=this.componentToSystemQueries.get(t)||[];e.includes(i)||e.push(i),this.componentToSystemQueries.set(t,e)}this.systems.add(t,e,i,s);let a=this.systemQueries.get(i);if(!a)return this;for(let t of this.entities)t&&t.componentMask.contains(n)&&a.entities.add(t.id);return this}registerEntity(t){let e=new o;return this.componentCollections[t.id]=e,this.entities[t.id]=t,this.entitiesToCreate.add(t),t.onCreate(this),this}clearEntityComponents(t){for(let e of(this.componentCollections[t]=new o,this.systemQueries.values()))e.entities.has(t)&&e.entities.delete(t);return this}createEntity(){return new a(this,++this.nextEntityId)}destroyEntity(t){delete this.componentCollections[t];let e=this.entities[t];if(!e)throw Error(`world.destroyEntity: No entity found. entity id: ${t}`);for(let s of(delete this.entities[t],this.entitiesToCreate.delete(e),this.entitiesToDestroy.delete(e),this.systemQueries.values()))s.entities.has(t)&&s.entities.delete(t);for(let[e,s]of this.entitiesByTags)s.has(t)&&s.delete(t),0===s.size&&this.entitiesByTags.delete(e);return this}toJSON(){let t={resources:[],entities:[]};for(let[e,s]of this.resources.entries()){let o=s.toJSON?s.toJSON():{...s};t.resources.push({name:e.name,data:o})}for(let e of this.entities){if(!e)continue;let s=[],o=this.componentCollections[e.id];if(o)for(let t of o){let e=t.toJSON?t.toJSON():{...t};s.push({name:t.constructor.name,data:e})}t.entities.push({id:e.id,tags:Array.from(e.tags),components:s})}return t}static fromJSON(t,e){let s=new y;for(let o of t.resources){let t,i=e.resources[o.name];if(!i)throw Error(`Cannot hydrate resource: Class constructor for "${o.name}" not found in typeMapping.resources.`);i.fromJSON?t=i.fromJSON(o.data):Object.assign(t=new i,o.data),s.setResource(t)}let o=0;for(let e of t.entities)"number"==typeof e.id&&e.id>o&&(o=e.id);for(let i of(s.nextEntityId=o,t.entities)){let t=new a(s,i.id);for(let e of(s.registerEntity(t),i.tags))t.addTag(e);for(let s of i.components){let o,i=e.components[s.name];if(!i)throw Error(`Cannot hydrate component: Class constructor for "${s.name}" not found in typeMapping.components.`);i.fromJSON?o=i.fromJSON(s.data):Object.assign(o=new i,s.data),t.add(o)}}return s}}module.exports=e})();